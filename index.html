<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<title>NGTZ</title>
<link rel="manifest" href="./manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ========================================
   NGTZ TRACKER v4 ‚Äî Vercel Design System
   ======================================== */
@font-face{font-family:'Geist';src:local('Geist'),local('SF Pro Display'),local('Segoe UI');font-display:swap}
:root{
  --g:#00d47b;--gg:rgba(0,212,123,.18);--gb:rgba(0,212,123,.06);
  --y:#f5a623;--yg:rgba(245,166,35,.18);--yb:rgba(245,166,35,.06);
  --r:#e5484d;--rg:rgba(229,72,77,.18);--rb:rgba(229,72,77,.06);
  --rest:#7c66dc;--restg:rgba(124,102,220,.12);
  --shield:#f76b15;--shieldg:rgba(247,107,21,.1);
  --bg:#000;--s1:#0a0a0a;--s2:#111;--s3:#1a1a1a;--s4:#222;
  --brd:rgba(255,255,255,.08);--brd2:rgba(255,255,255,.12);
  --t:#ededed;--td:#888;--tm:#555;
  --rad:12px;--rads:8px;
  --font:'Geist',system-ui,-apple-system,sans-serif;
  --mono:'Geist Mono','JetBrains Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--t);min-height:100dvh;overflow-x:hidden;padding-bottom:72px;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:0;height:0}
button{font-family:var(--font);cursor:pointer;border:none;background:none}
input,select,textarea{font-family:var(--font)}

/* ======== ANIMATED BG BEAM ======== */
.beam{position:fixed;top:0;left:0;right:0;height:400px;pointer-events:none;z-index:0;overflow:hidden}
.beam::before{content:'';position:absolute;width:600px;height:600px;top:-300px;left:50%;transform:translateX(-50%);background:radial-gradient(ellipse,rgba(0,212,123,.07) 0%,rgba(0,212,123,.02) 40%,transparent 70%);animation:beamDrift 12s ease-in-out infinite alternate}
@keyframes beamDrift{0%{transform:translateX(-60%)}100%{transform:translateX(-40%)}}

/* ======== SCROLL REVEAL ======== */
.reveal{opacity:0;transform:translateY(16px);transition:opacity .5s ease,transform .5s ease}
.reveal.vis{opacity:1;transform:translateY(0)}

/* ======== HEADER ======== */
.hdr{position:sticky;top:0;z-index:100;background:rgba(0,0,0,.8);backdrop-filter:blur(20px) saturate(1.4);border-bottom:1px solid var(--brd);padding:12px 20px;display:flex;justify-content:space-between;align-items:center}
.logo{font-weight:700;font-size:17px;letter-spacing:-.3px;display:flex;align-items:center;gap:8px}
.logo-dot{width:8px;height:8px;border-radius:50%;background:var(--g);box-shadow:0 0 12px var(--g)}
.hdr-actions{display:flex;gap:4px}
.hdr-btn{width:34px;height:34px;border-radius:8px;background:transparent;border:1px solid var(--brd);color:var(--td);font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.hdr-btn:active{transform:scale(.9);background:var(--s2)}

/* ======== LEVEL STRIP ======== */
.lvl{padding:12px 20px;display:flex;align-items:center;gap:12px;position:relative;z-index:1}
.lvl-badge{font-family:var(--mono);font-size:11px;font-weight:700;color:var(--g);background:var(--gb);border:1px solid rgba(0,212,123,.2);padding:4px 10px;border-radius:6px;letter-spacing:.5px}
.lvl-info{flex:1}
.lvl-title{font-size:12px;font-weight:600;color:var(--td)}
.lvl-track{height:2px;background:var(--s3);border-radius:2px;margin-top:4px;overflow:hidden}
.lvl-fill{height:100%;background:var(--g);border-radius:2px;transition:width .8s cubic-bezier(.4,0,.2,1)}
.lvl-xp{font-family:var(--mono);font-size:10px;color:var(--tm)}

/* ======== SCORE HERO ======== */
.hero{text-align:center;padding:24px 20px 12px;position:relative;z-index:1}
.hero-pct{font-family:var(--mono);font-size:56px;font-weight:700;line-height:.9;letter-spacing:-3px;background:linear-gradient(180deg,var(--t) 30%,var(--tm) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero-label{font-size:11px;font-weight:500;color:var(--tm);margin-top:6px;letter-spacing:1px;text-transform:uppercase}

/* ======== WEEK STRIP ======== */
.wk{display:flex;justify-content:center;gap:6px;padding:8px 20px 16px;position:relative;z-index:1}
.wk-d{display:flex;flex-direction:column;align-items:center;gap:4px}
.wk-l{font-size:9px;font-weight:600;color:var(--tm);letter-spacing:.5px}
.wk-c{width:32px;height:32px;border-radius:8px;background:var(--s2);border:1px solid var(--brd);display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:11px;font-weight:600;color:var(--tm);transition:all .25s}
.wk-c.g{background:var(--g);color:#000;border-color:var(--g)}.wk-c.y{background:var(--y);color:#000;border-color:var(--y)}.wk-c.r{background:var(--r);color:#fff;border-color:var(--r)}
.wk-c.today{box-shadow:0 0 0 2px var(--bg),0 0 0 3.5px var(--t)}

/* ======== DATE NAV ======== */
.dnav{display:flex;align-items:center;justify-content:center;gap:16px;padding:0 20px 14px;position:relative;z-index:1}
.dnav-btn{width:32px;height:32px;border-radius:8px;border:1px solid var(--brd);color:var(--td);font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.dnav-btn:active{transform:scale(.88);background:var(--s2)}
.dnav-c{text-align:center}
.dnav-main{font-size:15px;font-weight:700;letter-spacing:-.3px}
.dnav-sub{font-size:10px;color:var(--tm);margin-top:1px;font-weight:500}
.dnav-today{font-family:var(--mono);font-size:9px;font-weight:600;color:var(--g);background:var(--gb);border:1px solid rgba(0,212,123,.2);padding:3px 10px;border-radius:6px;letter-spacing:.5px}

/* ======== WARNING BANNER ======== */
.warn{margin:0 20px 10px;padding:10px 14px;border-radius:var(--rads);font-size:12px;font-weight:600;display:flex;align-items:center;gap:8px}
.warn.crit{background:var(--rb);border:1px solid rgba(229,72,77,.2);color:var(--r)}
.warn.caution{background:var(--yb);border:1px solid rgba(245,166,35,.2);color:var(--y)}

/* ======== SECTION ======== */
.sec{padding:0 20px;margin-bottom:20px;position:relative;z-index:1}
.sec-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.sec-t{font-size:12px;font-weight:700;color:var(--tm);text-transform:uppercase;letter-spacing:.8px}

/* ======== CATEGORY DIVIDER ======== */
.cat-div{font-size:10px;font-weight:700;color:var(--tm);padding:14px 0 8px;display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:.8px}
.cat-div::after{content:'';flex:1;height:1px;background:var(--brd)}

/* ======== HABIT CARD ======== */
.hc{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:14px 14px 12px;margin-bottom:6px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s,border-color .2s}
.hc:active{transform:translateY(-1px);box-shadow:0 8px 30px rgba(0,0,0,.4);border-color:var(--brd2)}
.hc::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;transition:background .2s}
.hc.st-g::before{background:var(--g)}.hc.st-y::before{background:var(--y)}.hc.st-r::before{background:var(--r)}.hc.st-rest::before{background:var(--rest)}.hc.st-n::before{background:var(--s3)}

.hc-row1{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.hc-name{font-size:14px;font-weight:700;letter-spacing:-.2px;display:flex;align-items:center;gap:6px}
.hc-tag{font-family:var(--mono);font-size:8px;padding:2px 5px;border-radius:4px;font-weight:600;letter-spacing:.3px}
.hc-tag.core{background:var(--gb);color:var(--g)}.hc-tag.growth{background:var(--yb);color:var(--y)}.hc-tag.shield{background:var(--shieldg);color:var(--shield)}
.hc-streak{font-family:var(--mono);font-size:10px;font-weight:600;color:var(--tm)}
.hc-streak.on{color:var(--g)}

.hc-row2{display:flex;align-items:center;gap:6px;margin-bottom:10px}
.hc-wk-tag{font-family:var(--mono);font-size:9px;padding:2px 7px;border-radius:4px;font-weight:600}
.hc-wk-tag.ok{background:var(--gb);color:var(--g)}.hc-wk-tag.warn{background:var(--yb);color:var(--y)}.hc-wk-tag.crit{background:var(--rb);color:var(--r)}.hc-wk-tag.done{background:var(--gg);color:var(--g)}
.hc-meta{font-size:10px;color:var(--tm)}

.hc-btns{display:flex;gap:4px}
.hc-btn{flex:1;padding:8px 4px;border-radius:var(--rads);border:1px solid var(--brd);font-size:10px;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:1px;color:var(--tm);transition:all .2s;background:transparent}
.hc-btn .ico{font-size:16px;transition:transform .15s}
.hc-btn:active{transform:scale(.93)}
.hc-btn:active .ico{transform:scale(1.2)}
.hc-btn.g-sel{background:var(--gb);border-color:var(--g);color:var(--g);box-shadow:0 0 20px rgba(0,212,123,.12)}
.hc-btn.y-sel{background:var(--yb);border-color:var(--y);color:var(--y);box-shadow:0 0 20px rgba(245,166,35,.12)}
.hc-btn.r-sel{background:var(--rb);border-color:var(--r);color:var(--r);box-shadow:0 0 20px rgba(229,72,77,.12)}
.hc-btn.rest-sel{background:var(--restg);border-color:var(--rest);color:var(--rest)}

.hc-expand{font-size:10px;color:var(--tm);padding:6px 0 0;display:none;line-height:1.5;border-top:1px solid var(--brd);margin-top:8px;padding-top:8px}
.hc-expand.show{display:block}

/* ======== END OF DAY BLOCK ======== */
.eod{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:16px;margin:0 20px 20px;position:relative;z-index:1}
.eod-title{font-size:12px;font-weight:700;color:var(--td);text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px}
.eod-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.eod-lbl{font-size:11px;color:var(--tm);font-weight:600;min-width:48px}
.mood-btn{width:34px;height:34px;border-radius:8px;background:var(--s2);border:1px solid transparent;font-size:17px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.mood-btn.sel{border-color:var(--g);background:var(--gb);transform:scale(1.12)}
.mood-btn:active{transform:scale(.9)}
.eod-note{width:100%;padding:8px 10px;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rads);color:var(--t);font-size:12px;resize:none;outline:none;min-height:38px;transition:border-color .2s}
.eod-note:focus{border-color:var(--g)}
.eod-note::placeholder{color:var(--tm)}

/* ======== MOMENT PROMPT ======== */
.mprompt{margin:0 20px 12px;padding:14px;background:var(--s1);border:1px solid rgba(0,212,123,.15);border-radius:var(--rad);position:relative;z-index:1}
.mprompt-t{font-size:12px;font-weight:700;color:var(--td);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.mprompt-date{font-family:var(--mono);font-size:10px;color:var(--tm)}
.mprompt-input{width:100%;padding:8px 10px;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rads);color:var(--t);font-size:12px;resize:none;outline:none;min-height:38px}
.mprompt-input:focus{border-color:var(--g)}
.mprompt-save{font-family:var(--mono);font-size:10px;font-weight:600;color:var(--g);background:var(--gb);border:1px solid rgba(0,212,123,.2);padding:5px 12px;border-radius:6px;margin-top:8px;transition:all .2s}
.mprompt-save:active{transform:scale(.95)}

/* ======== JOURNAL TAB ======== */
.j-cal{display:flex;gap:4px;padding:4px 0 16px;overflow-x:auto;scrollbar-width:none}
.j-cal::-webkit-scrollbar{display:none}
.j-cal-d{min-width:44px;padding:8px 6px;border-radius:var(--rads);background:var(--s1);border:1px solid var(--brd);text-align:center;cursor:pointer;transition:all .2s;flex-shrink:0}
.j-cal-d.sel{border-color:var(--g);background:var(--gb)}
.j-cal-d.has-moment{border-color:var(--brd2)}
.j-cal-dl{font-size:8px;color:var(--tm);font-weight:600;letter-spacing:.5px}
.j-cal-dn{font-family:var(--mono);font-size:14px;font-weight:700;margin-top:2px}
.j-cal-dot{width:4px;height:4px;border-radius:50%;background:var(--g);margin:4px auto 0;opacity:0}
.j-cal-d.has-moment .j-cal-dot{opacity:1}

.j-editor{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:16px;margin-bottom:16px}
.j-editor-date{font-family:var(--mono);font-size:11px;color:var(--g);font-weight:600;margin-bottom:8px}
.j-editor-ta{width:100%;padding:10px 12px;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rads);color:var(--t);font-size:13px;resize:none;outline:none;min-height:60px;line-height:1.6;transition:border-color .2s}
.j-editor-ta:focus{border-color:var(--g)}
.j-editor-ta::placeholder{color:var(--tm)}
.j-editor-actions{display:flex;gap:6px;margin-top:8px;align-items:center}
.j-editor-save{font-family:var(--mono);font-size:10px;font-weight:600;color:#000;background:var(--g);padding:6px 14px;border-radius:6px;transition:all .2s}
.j-editor-save:active{transform:scale(.95)}
.j-editor-del{font-size:10px;color:var(--tm);text-decoration:underline;text-underline-offset:2px}
.j-editor-mood{display:flex;gap:4px;margin-left:auto}
.j-editor-mood .mood-btn{width:28px;height:28px;font-size:14px}

.j-timeline-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--brd);align-items:flex-start}
.j-timeline-item:last-child{border-bottom:none}
.j-tl-date{font-family:var(--mono);font-size:10px;font-weight:600;color:var(--g);min-width:40px;padding-top:2px}
.j-tl-text{font-size:13px;color:var(--td);line-height:1.5;flex:1}
.j-tl-mood{font-size:14px;display:flex;gap:2px}

/* ======== VISION BOARD ======== */
.vis-card{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:16px;margin-bottom:16px}
.vis-title{font-size:14px;font-weight:800;letter-spacing:-.3px;margin-bottom:12px}
.vis-goal{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--brd);align-items:flex-start}
.vis-goal:last-child{border-bottom:none}
.vis-ico{font-size:18px;min-width:28px;text-align:center}
.vis-type{font-family:var(--mono);font-size:9px;font-weight:600;color:var(--tm);text-transform:uppercase;letter-spacing:.5px}
.vis-text{font-size:13px;font-weight:600;margin-top:2px;line-height:1.4}
.vis-edit{display:block;width:100%;padding:8px;margin-top:10px;border:1px solid var(--brd);border-radius:var(--rads);color:var(--td);font-size:11px;font-weight:600;text-align:center;transition:all .2s}
.vis-edit:active{background:var(--s2)}

/* ======== STATS ======== */
.stats-row{display:flex;gap:6px;padding:8px 20px;overflow-x:auto;scrollbar-width:none}
.stats-row::-webkit-scrollbar{display:none}
.st-c{flex-shrink:0;background:var(--s1);border:1px solid var(--brd);border-radius:var(--rads);padding:10px 14px;min-width:84px;text-align:center;transition:all .2s}
.st-v{font-family:var(--mono);font-size:20px;font-weight:700;line-height:1}
.st-v.g{color:var(--g)}.st-v.y{color:var(--y)}.st-v.r{color:var(--r)}.st-v.gr{color:var(--g)}
.st-l{font-size:8px;color:var(--tm);margin-top:3px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}

/* ======== MOOD CHART ======== */
.mchart{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:14px;margin-bottom:12px}
.mchart svg{width:100%;height:140px}
.mchart-leg{display:flex;gap:14px;margin-top:8px;justify-content:center}
.mchart-leg-i{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--td)}
.mchart-leg-d{width:8px;height:8px;border-radius:50%}

/* ======== WEEKLY REPORT ======== */
.wr{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:16px;margin-bottom:12px}
.wr-t{font-size:14px;font-weight:800;letter-spacing:-.3px;margin-bottom:12px}
.wr-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.wr-i{background:var(--s2);border-radius:var(--rads);padding:10px;text-align:center}
.wr-iv{font-family:var(--mono);font-size:20px;font-weight:700}
.wr-il{font-size:9px;color:var(--tm);margin-top:2px;text-transform:uppercase;letter-spacing:.3px}
.wr-msg{margin-top:10px;padding:10px;background:var(--s2);border-radius:var(--rads);font-size:12px;line-height:1.5;text-align:center;color:var(--td)}

/* ======== CHART ======== */
.chart{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:14px}
.chart-bars{display:flex;align-items:flex-end;gap:2px;height:80px;margin-top:8px}
.cb-g{flex:1;display:flex;flex-direction:column;align-items:center;height:100%;justify-content:flex-end}
.cb-b{width:100%;border-radius:2px 2px 0 0;min-height:1px;transition:height .5s ease}
.cb-b.g{background:var(--g)}.cb-b.y{background:var(--y)}.cb-b.r{background:var(--r)}
.cb-l{font-family:var(--mono);font-size:7px;color:var(--tm);margin-top:3px}

/* ======== HEATMAP ======== */
.hm{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:14px;margin-bottom:6px}
.hm-t{font-size:12px;font-weight:700;margin-bottom:2px}
.hm-s{font-family:var(--mono);font-size:9px;color:var(--tm);margin-bottom:8px}
.hm-g{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.hm-dl{font-size:7px;color:var(--tm);text-align:center;padding:1px 0;font-weight:600}
.hm-c{aspect-ratio:1;border-radius:2px;background:var(--s2);transition:all .2s}
.hm-c.g{background:var(--g);opacity:.8}.hm-c.y{background:var(--y);opacity:.75}.hm-c.r{background:var(--r);opacity:.35}
.hm-c.rest-c{background:var(--rest);opacity:.2}.hm-c.future{opacity:.1}.hm-c.today{outline:1.5px solid var(--t);outline-offset:1px}

/* ======== MILESTONES ======== */
.ms-l{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
.ms-l::-webkit-scrollbar{display:none}
.ms-b{flex-shrink:0;width:66px;text-align:center;padding:8px 4px;background:var(--s1);border:1px solid var(--brd);border-radius:var(--rads);transition:all .3s}
.ms-b.un{border-color:rgba(0,212,123,.2);background:var(--gb)}
.ms-b.lk{opacity:.25}
.ms-i{font-size:22px;margin-bottom:3px}
.ms-n{font-size:8px;font-weight:600;color:var(--td);line-height:1.2}

/* ======== SETTINGS ======== */
.set-i{display:flex;align-items:center;justify-content:space-between;background:var(--s1);border:1px solid var(--brd);border-radius:var(--rads);padding:10px 12px;margin-bottom:4px;transition:all .2s}
.set-name{font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
.set-sub{font-family:var(--mono);font-size:10px;color:var(--tm);margin-top:1px}
.set-actions{display:flex;gap:4px;align-items:center}
.set-btn{width:28px;height:28px;border-radius:6px;border:1px solid var(--brd);color:var(--tm);font-size:11px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.set-btn:active{transform:scale(.9);background:var(--s2)}

/* ======== BOTTOM NAV ======== */
.bnav{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,.9);backdrop-filter:blur(20px) saturate(1.4);border-top:1px solid var(--brd);display:flex;justify-content:space-around;padding:6px 0 max(6px,env(safe-area-inset-bottom));z-index:100}
.bnav-i{display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px 14px;color:var(--tm);font-size:9px;font-weight:600;transition:color .2s;letter-spacing:.3px}
.bnav-i.act{color:var(--g)}
.bnav-ic{font-size:18px;transition:transform .2s}
.bnav-i.act .bnav-ic{transform:scale(1.1)}

/* ======== FAB ======== */
.fab{position:fixed;bottom:max(72px,calc(52px + env(safe-area-inset-bottom)));right:20px;width:48px;height:48px;border-radius:12px;background:var(--g);color:#000;font-size:24px;font-weight:300;display:flex;align-items:center;justify-content:center;z-index:99;box-shadow:0 4px 24px rgba(0,212,123,.2);transition:all .2s}
.fab:active{transform:scale(.88)}

/* ======== MODAL ======== */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);z-index:200;display:none;align-items:flex-end;justify-content:center}
.mo.show{display:flex}
.mo-c{background:var(--s1);border:1px solid var(--brd);border-radius:16px 16px 0 0;padding:20px 20px max(20px,env(safe-area-inset-bottom));width:100%;max-width:480px;max-height:85dvh;overflow-y:auto;animation:sUp .2s ease}
@keyframes sUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mo-handle{width:28px;height:3px;background:var(--s4);border-radius:3px;margin:0 auto 16px}
.mo-c h2{font-size:16px;font-weight:800;letter-spacing:-.3px;margin-bottom:16px}
.fg{margin-bottom:12px}
.fl{font-size:10px;font-weight:700;color:var(--tm);margin-bottom:4px;display:block;text-transform:uppercase;letter-spacing:.6px}
.fi,.fsel{width:100%;padding:9px 11px;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rads);color:var(--t);font-size:13px;outline:none;transition:border-color .2s}
.fi:focus,.fsel:focus{border-color:var(--g)}
.fi::placeholder{color:var(--tm)}
.fsel option{background:var(--s2)}
.fr{display:flex;gap:8px}.fr .fg{flex:1}
.btn-p{width:100%;padding:11px;background:var(--g);border:none;border-radius:var(--rads);color:#000;font-size:13px;font-weight:700;transition:all .2s;margin-top:6px}
.btn-p:active{transform:scale(.97);opacity:.9}
.btn-d{width:100%;padding:9px;margin-top:6px;background:var(--rb);border:1px solid rgba(229,72,77,.2);border-radius:var(--rads);color:var(--r);font-size:12px;font-weight:600}
.btn-c{width:100%;padding:9px;margin-top:6px;border:1px solid var(--brd);border-radius:var(--rads);color:var(--td);font-size:12px}

/* ======== TOAST ======== */
.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-16px);background:var(--s2);border:1px solid var(--brd);border-radius:8px;padding:8px 16px;font-size:12px;font-weight:600;z-index:300;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.tg{color:var(--g);border-color:rgba(0,212,123,.2)}.toast.tr{color:var(--r)}.toast.ty{color:var(--y)}

/* ======== VIEWS ======== */
.vw{display:none}.vw.act{display:block}

/* ======== CONFETTI ======== */
.confetti-piece{position:fixed;width:6px;height:6px;border-radius:1px;z-index:400;pointer-events:none;animation:confettiFall 1.5s ease forwards}
@keyframes confettiFall{0%{opacity:1;transform:translateY(0) rotate(0)}100%{opacity:0;transform:translateY(100vh) rotate(720deg)}}

/* ======== EMPTY STATE ======== */
.empty{text-align:center;padding:48px 20px;color:var(--tm)}
.empty-ico{font-size:36px;margin-bottom:10px;opacity:.4}
.empty-t{font-size:15px;font-weight:700;color:var(--td);margin-bottom:4px}
.empty-s{font-size:12px;line-height:1.5}
</style>
</head>
<body>
<div class="beam"></div>
<div class="toast" id="toast"></div>

<!-- HEADER -->
<div class="hdr"><div class="logo"><div class="logo-dot"></div>NGTZ</div><div class="hdr-actions"><button class="hdr-btn" onclick="exportData()">‚Üì</button><button class="hdr-btn" onclick="importData()">‚Üë</button></div></div>

<!-- ===== TODAY ===== -->
<div id="v-today" class="vw act">
  <div class="lvl" id="lvl-bar"></div>
  <div id="mprompt-area"></div>
  <div class="hero reveal" id="hero-sec"></div>
  <div class="wk reveal" id="wk-strip"></div>
  <div class="dnav"><button class="dnav-btn" onclick="chgDate(-1)">‚Äπ</button><div class="dnav-c"><div class="dnav-main" id="d-main"></div><div class="dnav-sub" id="d-sub"></div></div><button class="dnav-btn" onclick="chgDate(1)">‚Ä∫</button><button class="dnav-today" onclick="goToday()">TODAY</button></div>
  <div id="warn-area"></div>
  <div class="sec" id="habits-list"></div>
  <div id="eod-area"></div>
</div>

<!-- ===== JOURNAL ===== -->
<div id="v-journal" class="vw">
  <div style="padding-top:12px"></div>
  <div class="sec" id="vis-area"></div>
  <div class="sec">
    <div class="sec-h"><span class="sec-t">Moments</span></div>
    <div class="j-cal" id="j-cal"></div>
    <div id="j-editor-area"></div>
  </div>
  <div class="sec">
    <div class="sec-h"><span class="sec-t">Timeline</span></div>
    <div id="j-timeline"></div>
  </div>
</div>

<!-- ===== STATS ===== -->
<div id="v-stats" class="vw">
  <div style="padding-top:8px"></div>
  <div class="stats-row" id="stats-row"></div>
  <div class="sec" style="margin-top:14px"><div class="sec-h"><span class="sec-t">Mood & Habits</span></div><div id="mchart-area"></div></div>
  <div class="sec"><div class="sec-h"><span class="sec-t">Milestones</span></div><div class="ms-l" id="ms-list"></div></div>
  <div class="sec"><div class="sec-h"><span class="sec-t">Weekly Report</span><span id="wr-wk" style="font-family:var(--mono);font-size:10px;color:var(--tm)"></span></div><div id="wr-area"></div></div>
  <div class="sec"><div class="sec-h"><span class="sec-t">This Month</span><span id="ch-mo" style="font-family:var(--mono);font-size:10px;color:var(--tm)"></span></div><div class="chart" id="mo-chart"></div></div>
  <div class="sec" id="hm-sec"><div class="sec-h"><span class="sec-t">Heatmaps</span></div></div>
</div>

<!-- ===== SETTINGS ===== -->
<div id="v-settings" class="vw">
  <div style="padding-top:12px"></div>
  <div class="sec"><div class="sec-h"><span class="sec-t">Your Habits</span></div><div id="set-habits"></div></div>
  <div class="sec"><div class="sec-h"><span class="sec-t">Reminders</span></div><div style="background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:14px;font-size:12px;color:var(--td);line-height:1.7">üì± Set alarms on your phone:<br>‚Ä¢ <b>7:30 AM</b> ‚Äî Log yesterday's moment ‚ú®<br>‚Ä¢ <b>9:00 PM</b> ‚Äî Log your habits üìä<br>‚Ä¢ <b>10:00 PM</b> ‚Äî Rate your day üåô</div></div>
  <div class="sec"><div class="sec-h"><span class="sec-t">Data</span></div><button class="btn-d" onclick="if(confirm('Reset ALL data?')){localStorage.clear();location.reload()}">Reset All Data</button></div>
  <div style="text-align:center;padding:24px 20px 40px"><p style="font-family:var(--mono);font-size:10px;color:var(--tm)">NGTZ v4.0</p></div>
</div>

<button class="fab" id="fab" onclick="openAdd()">+</button>

<!-- MODAL: HABIT -->
<div class="mo" id="mo-habit"><div class="mo-c"><div class="mo-handle"></div>
  <h2 id="mh-title">New Habit</h2>
  <div class="fg"><label class="fl">Name</label><input class="fi" id="f-name" placeholder="e.g. Reading"></div>
  <div class="fg"><label class="fl">Category</label><select class="fsel" id="f-cat"><option value="core">üîí Core ‚Äî Non-negotiable</option><option value="growth">‚≠ê Growth ‚Äî Building</option><option value="shield">üõ°Ô∏è Shield ‚Äî Eliminating</option></select></div>
  <div id="f-core-growth"><div class="fg"><label class="fl">üü¢ Green ‚Äî V1.0 (Ideal)</label><input class="fi" id="f-green" placeholder="e.g. Read 1 hour"></div><div class="fg"><label class="fl">üü° Yellow ‚Äî V0.1 (Non-zero)</label><input class="fi" id="f-yellow" placeholder="e.g. Read 1 page"></div></div>
  <div id="f-shield-fields" style="display:none"><div class="fg"><label class="fl">üü¢ Green ‚Äî Didn't do it</label><input class="fi" id="f-green-s" placeholder="e.g. No snacking"></div><div class="fg"><label class="fl">üü° Yellow ‚Äî Controlled</label><input class="fi" id="f-yellow-s" placeholder="e.g. 1 small snack"></div></div>
  <div class="fr"><div class="fg"><label class="fl">Times / Week</label><select class="fsel" id="f-freq"><option value="7">7√ó Daily</option><option value="6">6√ó</option><option value="5">5√ó</option><option value="4">4√ó</option><option value="3">3√ó</option><option value="2">2√ó</option><option value="1">1√ó</option></select></div><div class="fg"><label class="fl">Rest Days</label><select class="fsel" id="f-free"></select></div></div>
  <button class="btn-p" id="btn-save" onclick="saveHabit()">Create Habit</button>
  <button class="btn-d" id="btn-del" style="display:none" onclick="delHabit()">Delete</button>
  <button class="btn-c" onclick="closeMo('mo-habit')">Cancel</button>
</div></div>

<!-- MODAL: VISION -->
<div class="mo" id="mo-vision"><div class="mo-c"><div class="mo-handle"></div>
  <h2>2026 Vision</h2>
  <p style="font-family:var(--mono);font-size:10px;color:var(--tm);margin-bottom:14px">5 Wealth Framework ‚Äî Sahil Bloom</p>
  <div class="fg"><label class="fl">‚è≥ Time</label><input class="fi" id="vg-time" placeholder="How I spend my time..."></div>
  <div class="fg"><label class="fl">üë• Social</label><input class="fi" id="vg-social" placeholder="Relationships I'm building..."></div>
  <div class="fg"><label class="fl">üß† Mental</label><input class="fi" id="vg-mental" placeholder="How I grow my mind..."></div>
  <div class="fg"><label class="fl">üí™ Physical</label><input class="fi" id="vg-physical" placeholder="How I care for my body..."></div>
  <div class="fg"><label class="fl">üí∞ Financial</label><input class="fi" id="vg-financial" placeholder="Financial goals..."></div>
  <button class="btn-p" onclick="saveVision()">Save Vision</button>
  <button class="btn-c" onclick="closeMo('mo-vision')">Cancel</button>
</div></div>

<!-- NAV -->
<div class="bnav">
  <button class="bnav-i act" onclick="nav('today',this)"><span class="bnav-ic">‚óâ</span>TODAY</button>
  <button class="bnav-i" onclick="nav('journal',this)"><span class="bnav-ic">‚ú¶</span>JOURNAL</button>
  <button class="bnav-i" onclick="nav('stats',this)"><span class="bnav-ic">‚ó´</span>STATS</button>
  <button class="bnav-i" onclick="nav('settings',this)"><span class="bnav-ic">‚öô</span>SETTINGS</button>
</div>

<script>
// ================================ DATA ================================
const SK='ngtz4';let D=load();let curDate=new Date();let editId=null;let journalDate=null;
function load(){try{const r=localStorage.getItem(SK);if(r){const d=JSON.parse(r);d.mood=d.mood||{};d.moments=d.moments||{};d.vision=d.vision||{};return d}}catch(e){}return{habits:[],entries:{},xp:0,milestones:[],mood:{},moments:{},vision:{}}}
function save(){localStorage.setItem(SK,JSON.stringify(D))}
function dk(d){const t=d instanceof Date?d:new Date(d);return t.getFullYear()+'-'+P(t.getMonth()+1)+'-'+P(t.getDate())}
function P(n){return String(n).padStart(2,'0')}
function todayDk(){return dk(new Date())}
function isToday(d){return dk(d)===todayDk()}
function getE(h,k){return D.entries[k]?.[h]||null}
function setE(h,k,s){if(!D.entries[k])D.entries[k]={};D.entries[k][h]=s;save()}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function haptic(){try{navigator.vibrate&&navigator.vibrate(8)}catch(e){}}

// ================================ XP ================================
const LVLS=[{n:'Starter',x:0},{n:'Builder',x:100},{n:'Consistent',x:300},{n:'Focused',x:600},{n:'Machine',x:1000},{n:'Relentless',x:1600},{n:'Unstoppable',x:2500},{n:'Elite',x:4000},{n:'Legend',x:6000},{n:'NGTZ Master',x:10000}];
function getLvl(){let l=0;for(let i=LVLS.length-1;i>=0;i--)if(D.xp>=LVLS[i].x){l=i;break}return l}
function getLI(){const l=getLvl(),c=LVLS[l],nx=LVLS[l+1]||{x:c.x+1000};return{lv:l+1,name:c.n,xp:D.xp,next:nx.x,pct:Math.min(100,(D.xp-c.x)/(nx.x-c.x)*100)}}
function addXP(a,r){D.xp+=a;save();toast((a>0?'+':'')+a+' XP ‚Äî '+r,'tg')}

// ================================ STREAKS ================================
function getStreak(h){const hb=D.habits.find(x=>x.id===h);if(!hb)return 0;let s=0,d=new Date();if(!getE(h,dk(d)))d.setDate(d.getDate()-1);for(let i=0;i<365;i++){const k=dk(d),e=getE(h,k);if(e==='green'||e==='yellow'||e==='rest')s++;else break;d.setDate(d.getDate()-1)}return s}
function bestStreak(h){let b=0,c=0,d=new Date();for(let i=0;i<365;i++){const k=dk(d),e=getE(h,k);if(e==='green'||e==='yellow'||e==='rest'){c++;b=Math.max(b,c)}else c=0;d.setDate(d.getDate()-1)}return b}
function streakMsg(s){if(s<3)return'';if(s<7)return'building';if(s<14)return'momentum';if(s<21)return'on fire';if(s<30)return'forming';if(s<66)return'unstoppable';return'this is you'}

// ================================ WEEKLY ================================
function wkStart(d){const t=new Date(d);const dy=t.getDay();t.setDate(t.getDate()-(dy===0?6:dy-1));t.setHours(0,0,0,0);return t}
function wkEnd(d){const s=wkStart(d);s.setDate(s.getDate()+6);return s}
function getWS(hid,ref){
  const h=D.habits.find(x=>x.id===hid);if(!h)return{done:0,target:7,left:0,rem:0,st:'ok'};
  const ws=wkStart(ref),tgt=parseInt(h.freq);let done=0;
  for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(d.getDate()+i);const e=getE(hid,dk(d));if(e==='green'||e==='yellow')done++}
  const we=wkEnd(ref),rd=new Date(ref);rd.setHours(0,0,0,0);
  const left=Math.floor((we-rd)/864e5)+1;const rem=Math.max(0,tgt-done);
  // Smart alerts: only warn when it's actually tight
  let st='ok';
  if(rem<=0)st='done';
  else if(left>0&&rem>=left)st='crit';  // must do every remaining day
  else if(left>0&&rem>=left-1&&left<=3)st='warn';  // only warn when 3 or fewer days left
  return{done,target:tgt,left,rem,st}
}

// ================================ SCORING ================================
function dayScore(k){let p=0,m=0;D.habits.forEach(h=>{const e=getE(h.id,k);if(e==='rest')return;m+=2;if(e==='green')p+=2;else if(e==='yellow')p+=1});return{pts:p,max:m,pct:m?Math.round(p/m*100):0}}

// ================================ MILESTONES ================================
const MDS=[
  {id:'first_green',ico:'üå±',n:'First Green',ck:()=>{let f=false;Object.values(D.entries).forEach(d=>Object.entries(d).forEach(([k,v])=>{if(!k.startsWith('_')&&v==='green')f=true}));return f}},
  {id:'streak_7',ico:'üî•',n:'7-Day Fire',ck:()=>D.habits.some(h=>getStreak(h.id)>=7)},
  {id:'streak_21',ico:'‚ö°',n:'21-Day',ck:()=>D.habits.some(h=>getStreak(h.id)>=21)},
  {id:'streak_66',ico:'üíé',n:'66-Day',ck:()=>D.habits.some(h=>getStreak(h.id)>=66)},
  {id:'xp500',ico:'‚≠ê',n:'500 XP',ck:()=>D.xp>=500},
  {id:'xp2k',ico:'üèÜ',n:'2000 XP',ck:()=>D.xp>=2000},
  {id:'perfect',ico:'üëë',n:'Perfect Day',ck:()=>Object.entries(D.entries).some(([,ents])=>{const v=Object.entries(ents).filter(([k])=>!k.startsWith('_')).map(([,v])=>v);return v.length>0&&v.length===D.habits.length&&v.every(x=>x==='green'||x==='rest')})},
  {id:'lvl5',ico:'üöÄ',n:'Level 5',ck:()=>getLvl()>=4},
  {id:'full',ico:'üéØ',n:'Full Stack',ck:()=>D.habits.length>=10},
  {id:'mom7',ico:'üìñ',n:'7 Moments',ck:()=>Object.keys(D.moments).length>=7},
  {id:'vis',ico:'üî≠',n:'Visionary',ck:()=>Object.values(D.vision).some(v=>v)},
];
function checkMS(){MDS.forEach(m=>{if(!D.milestones.includes(m.id)&&m.ck()){D.milestones.push(m.id);save();toast('üèÖ '+m.n+'!','tg')}})}

// ================================ NAV ================================
function nav(v,el){
  document.querySelectorAll('.vw').forEach(x=>x.classList.remove('act'));
  document.getElementById('v-'+v).classList.add('act');
  document.querySelectorAll('.bnav-i').forEach(x=>x.classList.remove('act'));
  if(el)el.classList.add('act');
  document.getElementById('fab').style.display=v==='today'?'flex':'none';
  if(v==='stats')renderStats();
  if(v==='settings')renderSettings();
  if(v==='journal')renderJournal();
  setTimeout(initReveal,50);
}
function chgDate(d){curDate.setDate(curDate.getDate()+d);renderToday()}
function goToday(){curDate=new Date();renderToday()}

// ================================ SCROLL REVEAL ================================
function initReveal(){
  const obs=new IntersectionObserver((entries)=>{entries.forEach(e=>{if(e.isIntersecting)e.target.classList.add('vis')})},{threshold:.1});
  document.querySelectorAll('.reveal:not(.vis)').forEach(el=>obs.observe(el));
}

// ================================ RENDER: TODAY ================================
function renderToday(){
  const k=dk(curDate);
  const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('d-main').textContent=days[curDate.getDay()]+', '+mos[curDate.getMonth()]+' '+curDate.getDate();
  document.getElementById('d-sub').textContent=isToday(curDate)?'Today':curDate.getFullYear();

  const li=getLI();
  document.getElementById('lvl-bar').innerHTML=`<div class="lvl-badge">LV${li.lv}</div><div class="lvl-info"><div class="lvl-title">${li.name} <span class="lvl-xp">${D.xp}/${li.next}</span></div><div class="lvl-track"><div class="lvl-fill" style="width:${li.pct}%"></div></div></div>`;

  const{pts,max,pct}=dayScore(k);
  document.getElementById('hero-sec').innerHTML=`<div class="hero-pct">${pct}%</div><div class="hero-label">${max>0?pts+'/'+max+' points':'no habits today'}</div>`;

  renderWk();renderWarns();renderMomentPrompt();renderHabits();renderEOD();
  setTimeout(initReveal,50);
}

function renderWk(){
  const ct=document.getElementById('wk-strip');const ls=['M','T','W','T','F','S','S'];const ws=wkStart(curDate);let h='';
  for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(d.getDate()+i);const{pct}=dayScore(dk(d));let c=pct>=70?'g':pct>=30?'y':pct>0?'r':'';if(isToday(d))c+=' today';h+=`<div class="wk-d"><span class="wk-l">${ls[i]}</span><div class="wk-c ${c}">${d.getDate()}</div></div>`}
  ct.innerHTML=h;
}

function renderWarns(){
  const a=document.getElementById('warn-area');
  if(!isToday(curDate)||!D.habits.length){a.innerHTML='';return}
  let cr=[],wa=[];
  D.habits.forEach(h=>{const ws=getWS(h.id,curDate);if(ws.st==='crit')cr.push(h.name);else if(ws.st==='warn')wa.push(h.name)});
  let html='';
  if(cr.length)html+=`<div class="warn crit">üö® ${cr.join(', ')} ‚Äî non-negotiable today</div>`;
  if(wa.length)html+=`<div class="warn caution">‚ö†Ô∏è ${wa.join(', ')} ‚Äî running tight</div>`;
  a.innerHTML=html;
}

function renderMomentPrompt(){
  const a=document.getElementById('mprompt-area');
  if(!isToday(curDate)){a.innerHTML='';return}
  const yd=new Date();yd.setDate(yd.getDate()-1);const ydk=dk(yd);
  if(D.moments[ydk]){a.innerHTML='';return}
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  a.innerHTML=`<div class="mprompt reveal"><div class="mprompt-t">‚ú® Yesterday's best moment<span class="mprompt-date">${mos[yd.getMonth()]} ${yd.getDate()}</span></div><textarea class="mprompt-input" id="mp-in" placeholder="What made yesterday worth it?"></textarea><button class="mprompt-save" onclick="saveMoment('${ydk}')">Save</button></div>`;
  setTimeout(initReveal,50);
}
function saveMoment(k){const v=document.getElementById('mp-in')?.value.trim();if(!v)return;D.moments[k]=v;save();renderMomentPrompt();addXP(3,'Moment ‚ú®');checkMS();haptic()}

// ================================ HABIT CARDS ================================
function renderHabits(){
  const ct=document.getElementById('habits-list');const k=dk(curDate);
  if(!D.habits.length){ct.innerHTML=`<div class="empty"><div class="empty-ico">üéØ</div><div class="empty-t">No habits yet</div><div class="empty-s">Tap + to create your first habit</div></div>`;return}
  const cats=[{k:'core',l:'üîí Core',h:[]},{k:'growth',l:'‚≠ê Growth',h:[]},{k:'shield',l:'üõ°Ô∏è Shield',h:[]}];
  D.habits.forEach(h=>{const c=cats.find(c=>c.k===(h.cat||'growth'));(c||cats[1]).h.push(h)});

  let html='';
  cats.forEach(cat=>{
    if(!cat.h.length)return;
    html+=`<div class="cat-div reveal">${cat.l}</div>`;
    cat.h.forEach((h,idx)=>{
      const e=getE(h.id,k);const streak=getStreak(h.id);const ws=getWS(h.id,curDate);
      const sc=e?'st-'+(e==='rest'?'rest':e):'st-n';
      const isSh=h.cat==='shield';
      let tagC='ok',tagT=ws.rem+' left ¬∑ '+ws.left+'d';
      if(ws.st==='done'){tagC='done';tagT='‚úì done'}
      else if(ws.st==='crit'){tagC='crit';tagT=ws.rem+' in '+ws.left+'d'}
      else if(ws.st==='warn'){tagC='warn';tagT=ws.rem+' left ‚ö†Ô∏è'}

      const sm=streakMsg(streak);
      const streakDisp=streak>0?`üî• ${streak}d${sm?' ¬∑ '+sm:''}`:'Day 1 üå±';
      const gl=isSh?'Clean':'V1.0';const yl=isSh?'Ctrl':'V0.1';const rl=isSh?'Fell':'Zero';
      const maxFree=7-parseInt(h.freq);

      html+=`<div class="hc ${sc} reveal" style="animation-delay:${idx*40}ms">
        <div class="hc-row1">
          <div class="hc-name">${esc(h.name)}<span class="hc-tag ${h.cat||'growth'}">${h.cat==='core'?'CORE':h.cat==='shield'?'SHIELD':'GROWTH'}</span></div>
          <div class="hc-streak ${streak>0?'on':''}">${streakDisp}</div>
        </div>
        <div class="hc-row2"><span class="hc-wk-tag ${tagC}">${tagT}</span><span class="hc-meta">${ws.done}/${ws.target} this week</span></div>
        <div class="hc-btns">
          <button class="hc-btn ${e==='green'?'g-sel':''}" onclick="logH('${h.id}','${k}','green')"><span class="ico">üü¢</span>${gl}</button>
          <button class="hc-btn ${e==='yellow'?'y-sel':''}" onclick="logH('${h.id}','${k}','yellow')"><span class="ico">üü°</span>${yl}</button>
          <button class="hc-btn ${e==='red'?'r-sel':''}" onclick="logH('${h.id}','${k}','red')"><span class="ico">üî¥</span>${rl}</button>
          ${maxFree>0?`<button class="hc-btn ${e==='rest'?'rest-sel':''}" onclick="logH('${h.id}','${k}','rest')"><span class="ico">üòé</span>Rest</button>`:''}
        </div>
        <div class="hc-expand" id="exp-${h.id}">üü¢ ${esc(h.greenDesc)}<br>üü° ${esc(h.yellowDesc)}</div>
        <button style="font-size:9px;color:var(--tm);background:none;border:none;padding:6px 0 0;width:100%;text-align:left" onclick="document.getElementById('exp-${h.id}').classList.toggle('show')">details ‚Üì</button>
      </div>`;
    });
  });
  ct.innerHTML=html;
  setTimeout(initReveal,50);
}

function logH(hid,k,status){
  haptic();
  const prev=getE(hid,k);
  if(prev===status){if(D.entries[k])delete D.entries[k][hid];if(prev==='green')D.xp=Math.max(0,D.xp-10);else if(prev==='yellow')D.xp=Math.max(0,D.xp-5);save()}
  else{if(prev==='green')D.xp=Math.max(0,D.xp-10);else if(prev==='yellow')D.xp=Math.max(0,D.xp-5);setE(hid,k,status);if(status==='green')addXP(10,'Green!');else if(status==='yellow')addXP(5,'Non-zero!');else if(status==='red')toast('Bounce back tomorrow üí™','tr');else if(status==='rest')toast('Recharging üòé','ty')}
  checkMS();renderToday();
  // Check daily completion
  const{pct}=dayScore(k);
  if(pct===100&&D.habits.length>0)confetti();
}

// ================================ END OF DAY ================================
function renderEOD(){
  const k=dk(curDate);const m=D.mood[k]||{};
  const moods=['üò´','üòï','üòê','üôÇ','üòÑ'];
  const stress=['üî¥','üü†','üü°','üü¢','üíö'];
  const note=D.entries[k]?.['_daynote']||'';
  document.getElementById('eod-area').innerHTML=`<div class="eod reveal">
    <div class="eod-title">End of Day</div>
    <div class="eod-row"><span class="eod-lbl">Mood</span>${moods.map((e,i)=>`<button class="mood-btn ${m.mood===i?'sel':''}" onclick="setMood('${k}','mood',${i})">${e}</button>`).join('')}</div>
    <div class="eod-row"><span class="eod-lbl">Stress</span>${stress.map((e,i)=>`<button class="mood-btn ${m.stress===i?'sel':''}" onclick="setMood('${k}','stress',${i})">${e}</button>`).join('')}</div>
    <textarea class="eod-note" placeholder="Quick note about today..." onchange="saveDayNote('${k}',this.value)">${esc(note)}</textarea>
  </div>`;
  setTimeout(initReveal,50);
}
function setMood(k,t,v){haptic();if(!D.mood[k])D.mood[k]={};D.mood[k][t]=v;save();renderEOD()}
function saveDayNote(k,v){if(!D.entries[k])D.entries[k]={};D.entries[k]['_daynote']=v;save()}

// ================================ JOURNAL ================================
function renderJournal(){
  renderVision();renderJCal();renderJTimeline();
}
const WT=[{k:'time',i:'‚è≥',l:'Time'},{k:'social',i:'üë•',l:'Social'},{k:'mental',i:'üß†',l:'Mental'},{k:'physical',i:'üí™',l:'Physical'},{k:'financial',i:'üí∞',l:'Financial'}];
function renderVision(){
  const a=document.getElementById('vis-area');const has=Object.values(D.vision).some(v=>v);
  let h=`<div class="vis-card reveal"><div class="vis-title">üî≠ 2026 Vision</div>`;
  if(has){WT.forEach(w=>{const v=D.vision[w.k]||'';if(v)h+=`<div class="vis-goal"><div class="vis-ico">${w.i}</div><div><div class="vis-type">${w.l} Wealth</div><div class="vis-text">${esc(v)}</div></div></div>`})}
  else h+=`<div style="text-align:center;padding:20px;color:var(--tm);font-size:12px">Define your vision across the 5 types of wealth</div>`;
  h+=`<button class="vis-edit" onclick="openVisEdit()">‚úèÔ∏è ${has?'Edit':'Set'} Vision</button></div>`;
  a.innerHTML=h;setTimeout(initReveal,50);
}
function openVisEdit(){WT.forEach(w=>{document.getElementById('vg-'+w.k).value=D.vision[w.k]||''});openMo('mo-vision')}
function saveVision(){WT.forEach(w=>{D.vision[w.k]=document.getElementById('vg-'+w.k).value.trim()});save();closeMo('mo-vision');renderVision();checkMS();toast('Vision saved ‚ú®','tg')}

function renderJCal(){
  const ct=document.getElementById('j-cal');const today=new Date();
  let html='';
  const dls=['S','M','T','W','T','F','S'];
  // Show last 30 days
  for(let i=29;i>=0;i--){
    const d=new Date(today);d.setDate(d.getDate()-i);const k=dk(d);
    const hasMom=!!D.moments[k];
    const sel=journalDate===k;
    html+=`<div class="j-cal-d ${sel?'sel':''} ${hasMom?'has-moment':''}" onclick="selJDay('${k}')"><div class="j-cal-dl">${dls[d.getDay()]}</div><div class="j-cal-dn">${d.getDate()}</div><div class="j-cal-dot"></div></div>`;
  }
  ct.innerHTML=html;
  // Auto-scroll to end
  setTimeout(()=>ct.scrollLeft=ct.scrollWidth,50);
  renderJEditor();
}

function selJDay(k){journalDate=k;renderJCal()}

function renderJEditor(){
  const a=document.getElementById('j-editor-area');
  if(!journalDate){a.innerHTML=`<div style="text-align:center;padding:20px;color:var(--tm);font-size:12px">Select a day above to add or edit a moment</div>`;return}
  const d=new Date(journalDate+'T12:00:00');
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const existing=D.moments[journalDate]||'';
  const moodData=D.mood[journalDate]||{};
  const moods=['üò´','üòï','üòê','üôÇ','üòÑ'];
  const stress=['üî¥','üü†','üü°','üü¢','üíö'];

  a.innerHTML=`<div class="j-editor reveal">
    <div class="j-editor-date">${days[d.getDay()]}, ${mos[d.getMonth()]} ${d.getDate()}</div>
    <textarea class="j-editor-ta" id="j-ta" placeholder="What was the best moment of this day?">${esc(existing)}</textarea>
    <div class="j-editor-actions">
      <button class="j-editor-save" onclick="saveJMoment()">Save</button>
      ${existing?`<button class="j-editor-del" onclick="delJMoment()">delete</button>`:''}
      <div class="j-editor-mood">
        ${moods.map((e,i)=>`<button class="mood-btn ${moodData.mood===i?'sel':''}" onclick="setJMood('mood',${i})">${e}</button>`).join('')}
      </div>
    </div>
  </div>`;
  setTimeout(initReveal,50);
}
function saveJMoment(){
  if(!journalDate)return;const v=document.getElementById('j-ta').value.trim();
  if(v){D.moments[journalDate]=v;if(!D.moments[journalDate])addXP(3,'Moment ‚ú®')}
  else delete D.moments[journalDate];
  save();renderJCal();renderJTimeline();checkMS();haptic();toast('Saved','tg');
}
function delJMoment(){if(!journalDate)return;delete D.moments[journalDate];save();renderJCal();renderJTimeline();haptic()}
function setJMood(t,v){if(!journalDate)return;if(!D.mood[journalDate])D.mood[journalDate]={};D.mood[journalDate][t]=v;save();renderJEditor();haptic()}

function renderJTimeline(){
  const ct=document.getElementById('j-timeline');
  const entries=Object.entries(D.moments).sort((a,b)=>b[0].localeCompare(a[0])).slice(0,30);
  if(!entries.length){ct.innerHTML=`<div style="text-align:center;padding:20px;color:var(--tm);font-size:12px">Moments will appear here as you log them</div>`;return}
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const moods=['üò´','üòï','üòê','üôÇ','üòÑ'];const stress=['üî¥','üü†','üü°','üü¢','üíö'];
  ct.innerHTML=entries.map(([k,v])=>{
    const d=new Date(k+'T12:00:00');const md=D.mood[k]||{};
    return`<div class="j-timeline-item reveal"><div class="j-tl-date">${mos[d.getMonth()]} ${d.getDate()}</div><div class="j-tl-text">${esc(v)}</div><div class="j-tl-mood">${md.mood!==undefined?moods[md.mood]:''}${md.stress!==undefined?stress[md.stress]:''}</div></div>`
  }).join('');
  setTimeout(initReveal,50);
}

// ================================ STATS ================================
function renderStats(){
  let g=0,y=0,r=0;
  Object.values(D.entries).forEach(d=>Object.entries(d).forEach(([k,v])=>{if(k.startsWith('_'))return;if(v==='green')g++;else if(v==='yellow')y++;else if(v==='red')r++}));
  const tot=g+y+r;const ov=tot?Math.round((g*2+y)/(tot*2)*100):0;
  let bs=0;D.habits.forEach(h=>{bs=Math.max(bs,bestStreak(h.id))});
  const nz=Object.entries(D.entries).filter(([,ents])=>Object.entries(ents).some(([k,v])=>!k.startsWith('_')&&(v==='green'||v==='yellow'))).length;

  document.getElementById('stats-row').innerHTML=`
    <div class="st-c"><div class="st-v gr">${ov}%</div><div class="st-l">Overall</div></div>
    <div class="st-c"><div class="st-v gr">${nz}</div><div class="st-l">Non-Zero</div></div>
    <div class="st-c"><div class="st-v g">${g}</div><div class="st-l">Greens</div></div>
    <div class="st-c"><div class="st-v y">${y}</div><div class="st-l">Yellows</div></div>
    <div class="st-c"><div class="st-v r">${r}</div><div class="st-l">Reds</div></div>
    <div class="st-c"><div class="st-v gr">${bs}d</div><div class="st-l">Best</div></div>
    <div class="st-c"><div class="st-v gr">${D.xp}</div><div class="st-l">XP</div></div>`;

  renderMoodChart();renderMilestones();renderWR();renderMC();renderHM();
  setTimeout(initReveal,50);
}

function renderMoodChart(){
  const a=document.getElementById('mchart-area');
  const entries=Object.entries(D.mood).sort((a,b)=>a[0].localeCompare(b[0])).slice(-30);
  if(entries.length<2){a.innerHTML=`<div class="mchart"><p style="font-size:11px;color:var(--tm);padding:24px 0;text-align:center">Log 2+ days of mood to see correlation</p></div>`;return}
  const w=320,h=120,pL=24,pR=8,pT=8,pB=4;const pw=w-pL-pR,ph=h-pT-pB;const n=entries.length;const gap=pw/(n-1);
  let mP='',sP='',bars='',mD='',sD='';
  entries.forEach(([k,m],i)=>{
    const x=pL+i*gap;const mY=pT+ph-(((m.mood??2)/4)*ph);const sY=pT+ph-(((m.stress??2)/4)*ph);
    const{pct}=dayScore(k);const bH=(pct/100)*ph;
    bars+=`<rect x="${x-2}" y="${pT+ph-bH}" width="4" height="${bH}" rx="1.5" fill="var(--g)" opacity=".1"/>`;
    mP+=(i===0?'M':'L')+x.toFixed(1)+','+mY.toFixed(1);
    sP+=(i===0?'M':'L')+x.toFixed(1)+','+sY.toFixed(1);
    mD+=`<circle cx="${x.toFixed(1)}" cy="${mY.toFixed(1)}" r="2.5" fill="var(--g)"/>`;
    sD+=`<circle cx="${x.toFixed(1)}" cy="${sY.toFixed(1)}" r="2.5" fill="var(--r)"/>`;
  });
  a.innerHTML=`<div class="mchart reveal"><svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">${bars}<path d="${mP}" fill="none" stroke="var(--g)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>${mD}<path d="${sP}" fill="none" stroke="var(--r)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="3 2"/>${sD}</svg>
  <div class="mchart-leg"><div class="mchart-leg-i"><div class="mchart-leg-d" style="background:var(--g)"></div>Mood</div><div class="mchart-leg-i"><div class="mchart-leg-d" style="background:var(--r)"></div>Stress</div><div class="mchart-leg-i"><div class="mchart-leg-d" style="background:var(--g);opacity:.15"></div>Habits %</div></div></div>`;
  setTimeout(initReveal,50);
}

function renderMilestones(){document.getElementById('ms-list').innerHTML=MDS.map(m=>`<div class="ms-b ${D.milestones.includes(m.id)?'un':'lk'}"><div class="ms-i">${m.ico}</div><div class="ms-n">${m.n}</div></div>`).join('')}

function renderWR(){
  const t=new Date(),lm=wkStart(t);lm.setDate(lm.getDate()-7);const ls=new Date(lm);ls.setDate(ls.getDate()+6);
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('wr-wk').textContent=mos[lm.getMonth()]+' '+lm.getDate()+'‚Äì'+ls.getDate();
  let g=0,y=0,r=0,tot=0,hs={};
  for(let i=0;i<7;i++){const d=new Date(lm);d.setDate(d.getDate()+i);const k=dk(d);D.habits.forEach(h=>{const e=getE(h.id,k);if(!e||e==='rest')return;tot++;if(e==='green'){g++;hs[h.name]=(hs[h.name]||0)+2}else if(e==='yellow'){y++;hs[h.name]=(hs[h.name]||0)+1}else{r++;hs[h.name]=(hs[h.name]||0)}})}
  const pct=tot?Math.round((g*2+y)/(tot*2)*100):0;
  const es=Object.entries(hs);let bH='‚Äî',wH='‚Äî';
  if(es.length){es.sort((a,b)=>b[1]-a[1]);bH=es[0][0];wH=es[es.length-1][0]}
  const msg=pct>=90?'"You fall to the level of your systems." ‚Äî Yours are solid. üèÜ':pct>=70?'"Consistency beats intensity." üí™':pct>=50?'"Yellow beats zero." Room to grow. üü°':pct>0?'"You didn\'t stop tracking." That counts. üõ°Ô∏è':'"Every master was once a disaster." Start now. üå±';
  document.getElementById('wr-area').innerHTML=`<div class="wr reveal"><div class="wr-t">Weekly Report</div><div class="wr-grid"><div class="wr-i"><div class="wr-iv" style="color:var(--g)">${pct}%</div><div class="wr-il">Score</div></div><div class="wr-i"><div class="wr-iv">${g}<span style="font-size:11px;color:var(--tm)">/${y}/${r}</span></div><div class="wr-il">G/Y/R</div></div><div class="wr-i"><div class="wr-iv" style="font-size:13px;color:var(--g)">${bH}</div><div class="wr-il">Best</div></div><div class="wr-i"><div class="wr-iv" style="font-size:13px;color:var(--y)">${wH}</div><div class="wr-il">Needs Love</div></div></div><div class="wr-msg">${msg}</div></div>`;
  setTimeout(initReveal,50);
}

function renderMC(){
  const now=new Date(),yr=now.getFullYear(),mo=now.getMonth(),dim=new Date(yr,mo+1,0).getDate();
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('ch-mo').textContent=mos[mo]+' '+yr;
  let h='<div class="chart-bars">';
  for(let d=1;d<=dim;d++){const k=dk(new Date(yr,mo,d));const{pct}=dayScore(k);const c=pct>=70?'g':pct>=30?'y':pct>0?'r':'';h+=`<div class="cb-g"><div class="cb-b ${c}" style="height:${Math.max(pct,1)}%"></div>${d%5===1?`<span class="cb-l">${d}</span>`:''}</div>`}
  document.getElementById('mo-chart').innerHTML=h+'</div>';
}

function renderHM(){
  const ct=document.getElementById('hm-sec');let html='<div class="sec-h"><span class="sec-t">Heatmaps</span></div>';
  if(!D.habits.length){ct.innerHTML=html;return}
  D.habits.slice(0,5).forEach(h=>{
    html+=`<div class="hm reveal"><div class="hm-t">${esc(h.name)}</div><div class="hm-s">üî• ${getStreak(h.id)}d ¬∑ best ${bestStreak(h.id)}d</div><div class="hm-g">`;
    ['M','T','W','T','F','S','S'].forEach(d=>html+=`<div class="hm-dl">${d}</div>`);
    const today=new Date(),start=new Date(today);start.setDate(start.getDate()-34);const dow=start.getDay();start.setDate(start.getDate()-(dow===0?6:dow-1));
    for(let i=0;i<42;i++){const d=new Date(start);d.setDate(d.getDate()+i);const k2=dk(d);const e=getE(h.id,k2);const isFut=d>today;let cls=isFut?'future':e==='rest'?'rest-c':(e||'');if(isToday(d))cls+=' today';html+=`<div class="hm-c ${cls}"></div>`}
    html+='</div></div>';
  });
  if(D.habits.length>5)html+=`<p style="font-size:11px;color:var(--tm);text-align:center;padding:8px">Showing top 5 habits</p>`;
  ct.innerHTML=html;setTimeout(initReveal,50);
}

// ================================ SETTINGS ================================
function renderSettings(){
  const ct=document.getElementById('set-habits');
  if(!D.habits.length){ct.innerHTML='<p style="font-size:12px;color:var(--tm)">No habits yet</p>';return}
  const cl={core:'üîí',growth:'‚≠ê',shield:'üõ°Ô∏è'};
  ct.innerHTML=D.habits.map((h,i)=>`<div class="set-i"><div><div class="set-name">${cl[h.cat||'growth']} ${esc(h.name)}</div><div class="set-sub">${h.freq}√ó/wk ¬∑ üî• ${getStreak(h.id)}d</div></div><div class="set-actions">${i>0?`<button class="set-btn" onclick="moveH(${i},-1)">‚Üë</button>`:''}${i<D.habits.length-1?`<button class="set-btn" onclick="moveH(${i},1)">‚Üì</button>`:''}<button class="set-btn" onclick="openEdit('${h.id}')">‚úè</button></div></div>`).join('');
}
function moveH(i,dir){const j=i+dir;if(j<0||j>=D.habits.length)return;[D.habits[i],D.habits[j]]=[D.habits[j],D.habits[i]];save();renderSettings();haptic()}

// ================================ HABIT MODAL ================================
const fCat=document.getElementById('f-cat');const fFreq=document.getElementById('f-freq');
fCat.addEventListener('change',toggleSh);
fFreq.addEventListener('change',updateFreeOpts);
function toggleSh(){const s=fCat.value==='shield';document.getElementById('f-core-growth').style.display=s?'none':'block';document.getElementById('f-shield-fields').style.display=s?'block':'none'}
function updateFreeOpts(){const freq=parseInt(fFreq.value);const max=7-freq;const sel=document.getElementById('f-free');const cur=parseInt(sel.value)||0;sel.innerHTML='';for(let i=0;i<=max;i++)sel.innerHTML+=`<option value="${i}"${i===Math.min(cur,max)?' selected':''}>${i}</option>`}

function openAdd(){
  editId=null;document.getElementById('mh-title').textContent='New Habit';
  ['f-name','f-green','f-yellow','f-green-s','f-yellow-s'].forEach(id=>document.getElementById(id).value='');
  fCat.value='growth';fFreq.value='7';toggleSh();updateFreeOpts();
  document.getElementById('btn-save').textContent='Create';document.getElementById('btn-del').style.display='none';
  openMo('mo-habit');
}
function openEdit(id){
  const h=D.habits.find(x=>x.id===id);if(!h)return;editId=id;
  document.getElementById('mh-title').textContent='Edit';
  document.getElementById('f-name').value=h.name;fCat.value=h.cat||'growth';fFreq.value=h.freq;toggleSh();updateFreeOpts();
  document.getElementById('f-free').value=h.freeDays||'0';
  if(h.cat==='shield'){document.getElementById('f-green-s').value=h.greenDesc;document.getElementById('f-yellow-s').value=h.yellowDesc}
  else{document.getElementById('f-green').value=h.greenDesc;document.getElementById('f-yellow').value=h.yellowDesc}
  document.getElementById('btn-save').textContent='Save';document.getElementById('btn-del').style.display='block';
  openMo('mo-habit');
}
function saveHabit(){
  const name=document.getElementById('f-name').value.trim();const cat=fCat.value;const isSh=cat==='shield';
  const gd=isSh?document.getElementById('f-green-s').value.trim():document.getElementById('f-green').value.trim();
  const yd=isSh?document.getElementById('f-yellow-s').value.trim():document.getElementById('f-yellow').value.trim();
  if(!name||!gd||!yd){toast('Fill all fields','tr');return}
  const freq=fFreq.value;const free=document.getElementById('f-free').value;
  if(editId){const h=D.habits.find(x=>x.id===editId);if(h){h.name=name;h.cat=cat;h.greenDesc=gd;h.yellowDesc=yd;h.freq=freq;h.freeDays=free}}
  else{D.habits.push({id:'h_'+Date.now(),name,cat,greenDesc:gd,yellowDesc:yd,freq,freeDays:free});toast('Habit created ‚úì','tg')}
  save();closeMo('mo-habit');renderToday();haptic();
}
function delHabit(){if(!editId||!confirm('Delete habit?'))return;D.habits=D.habits.filter(h=>h.id!==editId);Object.keys(D.entries).forEach(k=>{delete D.entries[k][editId]});save();closeMo('mo-habit');renderToday()}

// ================================ MODALS ================================
function openMo(id){document.getElementById(id).classList.add('show')}
function closeMo(id){document.getElementById(id).classList.remove('show')}
document.querySelectorAll('.mo').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)closeMo(m.id)}));

// ================================ EXPORT/IMPORT ================================
function exportData(){const b=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='ngtz-'+todayDk()+'.json';a.click();toast('Exported ‚úì','tg')}
function importData(){const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const imp=JSON.parse(r.result);if(imp.habits&&imp.entries){if(confirm('Replace all data?')){D=imp;D.mood=D.mood||{};D.moments=D.moments||{};D.vision=D.vision||{};save();renderToday();toast('Imported ‚úì','tg')}}else toast('Invalid file','tr')}catch(e){toast('Error','tr')}};r.readAsText(f)};i.click()}

// ================================ CONFETTI ================================
function confetti(){const colors=['var(--g)','var(--y)','#fff','#7c66dc'];for(let i=0;i<24;i++){const el=document.createElement('div');el.className='confetti-piece';el.style.cssText=`left:${Math.random()*100}%;top:-8px;background:${colors[i%4]};transform:rotate(${Math.random()*360}deg);animation-duration:${1+Math.random()}s;animation-delay:${Math.random()*.3}s;width:${4+Math.random()*4}px;height:${4+Math.random()*4}px;border-radius:${Math.random()>.5?'50%':'1px'}`;document.body.appendChild(el);setTimeout(()=>el.remove(),2000)}toast('Perfect day! üëë','tg')}

// ================================ TOAST ================================
function toast(m,c){const t=document.getElementById('toast');t.textContent=m;t.className='toast '+(c||'')+' show';setTimeout(()=>t.classList.remove('show'),2200)}

// ================================ SW ================================
if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js').catch(()=>{});

// ================================ INIT ================================
renderToday();checkMS();setTimeout(initReveal,100);
</script>
</body>
</html>
