<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#08080d">
<title>NGTZ Tracker</title>
<link rel="manifest" href="./manifest.json">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
--g:#22c55e;--gg:rgba(34,197,94,.2);--gb:rgba(34,197,94,.07);
--y:#eab308;--yg:rgba(234,179,8,.2);--yb:rgba(234,179,8,.07);
--r:#ef4444;--rg:rgba(239,68,68,.2);--rb:rgba(239,68,68,.07);
--rest:#6366f1;--restg:rgba(99,102,241,.15);
--shield:#f97316;--shieldg:rgba(249,115,22,.15);
--bg:#08080d;--s1:#101018;--s2:#16161f;--s3:#1e1e2a;
--brd:rgba(255,255,255,.05);
--t:#ededf2;--td:#8585a0;--tm:#4a4a62;
--rad:14px;--rads:10px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t);min-height:100dvh;overflow-x:hidden;padding-bottom:80px}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--s3);border-radius:3px}
button{font-family:inherit;cursor:pointer}input,select,textarea{font-family:inherit}

/* HEADER */
.hdr{position:sticky;top:0;z-index:100;background:rgba(8,8,13,.88);backdrop-filter:blur(24px);border-bottom:1px solid var(--brd);padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
.logo{font-weight:800;font-size:19px;letter-spacing:-.5px;display:flex;align-items:center;gap:8px}
.logo-mark{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--g),var(--y));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#000}
.hdr-actions{display:flex;gap:6px}
.hdr-btn{width:36px;height:36px;border-radius:10px;background:var(--s2);border:1px solid var(--brd);color:var(--td);font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.hdr-btn:active{transform:scale(.9)}

/* LEVEL BAR */
.lvl-bar{padding:10px 18px;display:flex;align-items:center;gap:12px}
.lvl-badge{min-width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--g),#059669);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;line-height:1}
.lvl-num{font-size:18px;font-weight:700;color:#fff}
.lvl-lbl{font-size:7px;font-weight:600;color:rgba(255,255,255,.7);text-transform:uppercase;letter-spacing:.5px}
.lvl-info{flex:1}
.lvl-title{font-size:14px;font-weight:700}
.lvl-xp-text{font-size:11px;color:var(--td);margin-top:1px;font-family:'JetBrains Mono',monospace}
.lvl-xp-track{height:4px;background:var(--s3);border-radius:4px;margin-top:5px;overflow:hidden}
.lvl-xp-fill{height:100%;background:linear-gradient(90deg,var(--g),var(--y));border-radius:4px;transition:width .6s ease}

/* DATE NAV */
.date-nav{display:flex;align-items:center;justify-content:center;gap:14px;padding:6px 18px 14px}
.dn-btn{width:34px;height:34px;border-radius:10px;background:var(--s1);border:1px solid var(--brd);color:var(--td);font-size:15px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.dn-btn:active{transform:scale(.88)}
.dn-center{text-align:center}
.dn-main{font-size:17px;font-weight:700}
.dn-sub{font-size:11px;color:var(--tm);margin-top:1px}
.dn-today{font-size:10px;font-weight:700;color:var(--g);background:var(--gb);border:1px solid var(--gg);padding:3px 10px;border-radius:20px;cursor:pointer}

/* WEEK STRIP */
.week-strip{display:flex;justify-content:center;gap:5px;padding:0 18px 14px}
.ws-day{display:flex;flex-direction:column;align-items:center;gap:3px}
.ws-lbl{font-size:9px;font-weight:600;color:var(--tm)}
.ws-dot{width:30px;height:30px;border-radius:8px;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--tm);transition:all .2s}
.ws-dot.g{background:var(--g);color:#fff}.ws-dot.y{background:var(--y);color:#fff}.ws-dot.r{background:var(--r);color:#fff}
.ws-dot.today{outline:2px solid var(--t);outline-offset:2px}

/* SCORE RING */
.score-sec{text-align:center;padding:16px 18px 4px}
.score-wrap{position:relative;display:inline-block}
.score-ring{width:120px;height:120px}
.score-ring circle{fill:none;stroke-width:7}
.score-ring .bg{stroke:var(--s3)}
.score-ring .prog{stroke-linecap:round;transition:stroke-dashoffset .7s ease,stroke .3s}
.score-val{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700}
.score-lbl{font-size:11px;color:var(--tm);margin-top:6px;font-weight:500}

/* SECTIONS */
.sec{padding:0 18px;margin-bottom:20px}
.sec-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.sec-ttl{font-size:14px;font-weight:700;color:var(--td)}

/* WARNING BANNERS */
.warn-banner{margin:0 18px 10px;padding:11px 14px;border-radius:var(--rads);display:flex;align-items:center;gap:10px;font-size:12px;font-weight:600}
.warn-banner.urgent{background:var(--rb);border:1px solid rgba(239,68,68,.25);color:var(--r)}
.warn-banner.caution{background:var(--yb);border:1px solid rgba(234,179,8,.25);color:var(--y)}

/* MOOD/MOMENT PROMPT */
.prompt-card{margin:0 18px 12px;padding:14px;background:var(--s1);border:1px solid var(--gg);border-radius:var(--rad);animation:fadeUp .4s ease}
.prompt-title{font-size:13px;font-weight:700;margin-bottom:8px;color:var(--td)}
.prompt-input{width:100%;padding:10px 12px;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rads);color:var(--t);font-size:13px;resize:none;outline:none;min-height:40px}
.prompt-input:focus{border-color:var(--g)}
.prompt-row{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;align-items:center}
.prompt-lbl{font-size:11px;color:var(--tm);font-weight:600;min-width:45px}
.mood-btn{width:36px;height:36px;border-radius:10px;background:var(--s2);border:2px solid transparent;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.mood-btn.sel{border-color:var(--g);background:var(--gb);transform:scale(1.1)}
.mood-btn:active{transform:scale(.9)}
.prompt-save{padding:8px 16px;border-radius:var(--rads);background:var(--g);border:none;color:#fff;font-size:12px;font-weight:700;margin-top:8px}

/* HABIT CARD */
.hc{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:14px;margin-bottom:8px;position:relative;overflow:hidden;transition:all .3s;animation:fadeUp .3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.hc::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:0 3px 3px 0;transition:background .3s}
.hc.st-g::before{background:var(--g)}.hc.st-y::before{background:var(--y)}.hc.st-r::before{background:var(--r)}.hc.st-rest::before{background:var(--rest)}.hc.st-n::before{background:var(--s3)}
.hc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:3px}
.hc-name{font-size:15px;font-weight:700;flex:1;display:flex;align-items:center;gap:6px}
.hc-cat{font-size:9px;padding:2px 6px;border-radius:5px;font-weight:700;flex-shrink:0}
.hc-cat.core{background:rgba(34,197,94,.12);color:var(--g)}
.hc-cat.growth{background:rgba(234,179,8,.12);color:var(--y)}
.hc-cat.shield{background:var(--shieldg);color:var(--shield)}
.hc-streak{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;padding:3px 8px;border-radius:7px;background:var(--s2);color:var(--tm);display:flex;align-items:center;gap:3px;white-space:nowrap}
.hc-streak.on{color:var(--g);background:var(--gb)}
.hc-streak.danger{color:var(--r);background:var(--rb)}
.hc-meta{font-size:11px;color:var(--tm);margin-bottom:2px}
.hc-weekly{font-size:11px;color:var(--td);margin-bottom:10px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.hc-weekly-tag{padding:2px 7px;border-radius:5px;font-weight:600;font-size:10px}
.hc-weekly-tag.ok{background:var(--gb);color:var(--g)}
.hc-weekly-tag.warn{background:var(--yb);color:var(--y)}
.hc-weekly-tag.crit{background:var(--rb);color:var(--r)}
.hc-weekly-tag.done{background:var(--gg);color:var(--g)}
.hc-weekly-pips{display:flex;gap:3px}
.hc-pip{width:14px;height:6px;border-radius:3px;background:var(--s3)}
.hc-pip.g{background:var(--g)}.hc-pip.y{background:var(--y)}.hc-pip.r{background:var(--r)}

.hc-actions{display:flex;gap:6px}
.hc-btn{flex:1;padding:9px 6px;border-radius:var(--rads);border:2px solid transparent;font-size:11px;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:2px;background:var(--s2);color:var(--tm);transition:all .2s}
.hc-btn .ico{font-size:18px}
.hc-btn:active{transform:scale(.93)}
.hc-btn.g-sel{background:var(--gb);border-color:var(--g);color:var(--g);box-shadow:0 0 16px var(--gg)}
.hc-btn.y-sel{background:var(--yb);border-color:var(--y);color:var(--y);box-shadow:0 0 16px var(--yg)}
.hc-btn.r-sel{background:var(--rb);border-color:var(--r);color:var(--r);box-shadow:0 0 16px var(--rg)}
.hc-btn.rest-sel{background:var(--restg);border-color:var(--rest);color:var(--rest)}
.hc-note-toggle{font-size:11px;color:var(--tm);background:none;border:none;padding:6px 0 0;text-decoration:underline;text-underline-offset:2px}
.hc-note-area{margin-top:8px}
.hc-note-input{width:100%;padding:8px 10px;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rads);color:var(--t);font-size:12px;resize:none;outline:none;min-height:36px}

/* CATEGORY DIVIDER */
.cat-divider{font-size:11px;font-weight:700;color:var(--tm);padding:12px 0 6px;display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:.5px}
.cat-divider::after{content:'';flex:1;height:1px;background:var(--brd)}

/* EMPTY */
.empty{text-align:center;padding:50px 20px;color:var(--tm)}
.empty-ico{font-size:42px;margin-bottom:12px;opacity:.5}
.empty-ttl{font-size:17px;font-weight:700;color:var(--td);margin-bottom:6px}
.empty-txt{font-size:13px;line-height:1.5}

/* STATS */
.stats-row{display:flex;gap:6px;padding:8px 18px;overflow-x:auto;scrollbar-width:none}
.stats-row::-webkit-scrollbar{display:none}
.st-card{flex-shrink:0;background:var(--s1);border:1px solid var(--brd);border-radius:var(--rads);padding:10px 14px;min-width:88px;text-align:center}
.st-val{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;line-height:1}
.st-val.g{color:var(--g)}.st-val.y{color:var(--y)}.st-val.r{color:var(--r)}
.st-val.grad{background:linear-gradient(135deg,var(--g),var(--y));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.st-lbl{font-size:9px;color:var(--tm);margin-top:3px;font-weight:600;text-transform:uppercase;letter-spacing:.4px}

/* MOOD CHART (SVG) */
.mood-chart-wrap{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:14px;margin-bottom:12px}
.mood-chart-title{font-size:13px;font-weight:700;margin-bottom:10px}
.mood-chart-svg{width:100%;height:160px}
.mood-legend{display:flex;gap:12px;margin-top:8px;justify-content:center}
.mood-legend-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--td)}
.mood-legend-dot{width:8px;height:8px;border-radius:50%}

/* HEATMAP */
.hm-card{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:14px;margin-bottom:8px}
.hm-ttl{font-size:13px;font-weight:700;margin-bottom:2px}
.hm-sub{font-size:10px;color:var(--tm);margin-bottom:10px}
.hm-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.hm-dlbl{font-size:8px;color:var(--tm);text-align:center;padding:2px 0;font-weight:600}
.hm-cell{aspect-ratio:1;border-radius:3px;background:var(--s2);transition:all .2s}
.hm-cell.g{background:var(--g);opacity:.8}.hm-cell.y{background:var(--y);opacity:.8}.hm-cell.r{background:var(--r);opacity:.5}
.hm-cell.rest-c{background:var(--rest);opacity:.3}
.hm-cell.future{background:var(--s1);opacity:.3}.hm-cell.today{outline:2px solid var(--t);outline-offset:1px}

/* CHART BARS */
.chart-wrap{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:14px}
.chart-bars{display:flex;align-items:flex-end;gap:3px;height:100px;margin-top:10px}
.cb-grp{flex:1;display:flex;flex-direction:column;align-items:center;height:100%;justify-content:flex-end}
.cb-bar{width:100%;border-radius:3px 3px 0 0;min-height:1px;transition:height .5s ease}
.cb-bar.g{background:var(--g)}.cb-bar.y{background:var(--y)}.cb-bar.r{background:var(--r)}
.cb-lbl{font-size:7px;color:var(--tm);margin-top:3px}

/* MILESTONES */
.ms-list{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
.ms-list::-webkit-scrollbar{display:none}
.ms-badge{flex-shrink:0;width:72px;text-align:center;padding:10px 6px;background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad)}
.ms-badge.unlocked{border-color:var(--gg);background:var(--gb)}
.ms-badge.locked{opacity:.35}
.ms-ico{font-size:24px;margin-bottom:4px}
.ms-name{font-size:9px;font-weight:600;color:var(--td);line-height:1.2}

/* WEEKLY REPORT */
.wr-card{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:16px;margin-bottom:12px}
.wr-title{font-size:16px;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.wr-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.wr-item{background:var(--s2);border-radius:var(--rads);padding:10px;text-align:center}
.wr-item-val{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700}
.wr-item-lbl{font-size:10px;color:var(--tm);margin-top:2px}
.wr-msg{margin-top:12px;padding:12px;background:var(--s2);border-radius:var(--rads);font-size:13px;font-weight:500;line-height:1.5;text-align:center;font-style:italic;color:var(--td)}

/* MOMENTS TIMELINE */
.moment-item{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rads);padding:12px 14px;margin-bottom:6px;display:flex;gap:12px;align-items:flex-start}
.moment-date{font-size:11px;font-weight:700;color:var(--g);min-width:42px;padding-top:2px}
.moment-text{font-size:13px;color:var(--td);line-height:1.5;flex:1}
.moment-mood{display:flex;gap:4px;font-size:16px;min-width:44px;justify-content:flex-end}

/* VISION BOARD */
.vision-card{background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:16px;margin-bottom:12px}
.vision-title{font-size:16px;font-weight:800;margin-bottom:14px;text-align:center}
.vision-goal{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--brd)}
.vision-goal:last-child{border-bottom:none}
.vision-ico{font-size:22px;min-width:32px;text-align:center}
.vision-type{font-size:10px;font-weight:700;color:var(--tm);text-transform:uppercase;letter-spacing:.4px}
.vision-text{font-size:14px;font-weight:600;margin-top:2px;line-height:1.4}
.vision-empty{font-size:13px;color:var(--tm);text-align:center;padding:20px}
.vision-edit-btn{display:block;width:100%;padding:10px;margin-top:8px;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rads);color:var(--td);font-size:13px;font-weight:600;text-align:center;cursor:pointer}

/* SETTINGS */
.set-item{display:flex;align-items:center;justify-content:space-between;background:var(--s1);border:1px solid var(--brd);border-radius:var(--rads);padding:12px 14px;margin-bottom:6px}
.set-name{font-weight:600;font-size:14px;display:flex;align-items:center;gap:6px}
.set-sub{font-size:11px;color:var(--tm);margin-top:1px}
.set-edit{padding:5px 12px;border-radius:7px;background:var(--s2);border:1px solid var(--brd);color:var(--td);font-size:12px;font-weight:600}

/* BOTTOM NAV */
.bnav{position:fixed;bottom:0;left:0;right:0;background:rgba(8,8,13,.92);backdrop-filter:blur(20px);border-top:1px solid var(--brd);display:flex;justify-content:space-around;padding:6px 0 max(6px,env(safe-area-inset-bottom));z-index:100}
.bnav-i{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;border-radius:12px;background:none;border:none;color:var(--tm);font-size:10px;font-weight:600;transition:all .2s}
.bnav-i.act{color:var(--g)}
.bnav-ico{font-size:20px}

/* FAB */
.fab{position:fixed;bottom:max(76px,calc(56px + env(safe-area-inset-bottom)));right:18px;width:52px;height:52px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--g),#059669);color:#fff;font-size:26px;display:flex;align-items:center;justify-content:center;z-index:99;box-shadow:0 4px 20px var(--gg);transition:all .2s}
.fab:active{transform:scale(.88)}

/* MODAL */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);z-index:200;display:none;align-items:flex-end;justify-content:center}
.mo.show{display:flex}
.mo-c{background:var(--s1);border:1px solid var(--brd);border-radius:22px 22px 0 0;padding:20px 18px max(20px,env(safe-area-inset-bottom));width:100%;max-width:480px;max-height:85dvh;overflow-y:auto;animation:sUp .25s ease}
@keyframes sUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mo-handle{width:32px;height:3px;background:var(--s3);border-radius:3px;margin:0 auto 16px}
.mo-c h2{font-size:18px;font-weight:800;margin-bottom:16px}
.fg{margin-bottom:14px}
.fl{font-size:11px;font-weight:700;color:var(--td);margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:.4px}
.fi,.fsel{width:100%;padding:10px 12px;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rads);color:var(--t);font-size:14px;outline:none;transition:border .2s}
.fi:focus,.fsel:focus{border-color:var(--g)}
.fi::placeholder{color:var(--tm)}
.fsel option{background:var(--s2)}
.fr{display:flex;gap:8px}
.fr .fg{flex:1}
.btn-p{width:100%;padding:13px;background:linear-gradient(135deg,var(--g),#059669);border:none;border-radius:var(--rads);color:#fff;font-size:15px;font-weight:700;transition:all .2s;margin-top:6px}
.btn-p:active{transform:scale(.97)}
.btn-d{width:100%;padding:11px;margin-top:6px;background:var(--rb);border:1px solid rgba(239,68,68,.3);border-radius:var(--rads);color:var(--r);font-size:13px;font-weight:700;cursor:pointer}
.btn-c{width:100%;padding:11px;margin-top:6px;background:none;border:1px solid var(--brd);border-radius:var(--rads);color:var(--td);font-size:13px;cursor:pointer}

/* TOAST */
.toast{position:fixed;top:70px;left:50%;transform:translateX(-50%) translateY(-20px);background:var(--s2);border:1px solid var(--brd);border-radius:12px;padding:10px 18px;font-size:13px;font-weight:600;z-index:300;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.tg{color:var(--g);border-color:var(--gg)}.toast.tr{color:var(--r)}.toast.ty{color:var(--y)}

/* VIEWS */
.vw{display:none}.vw.act{display:block}
.pad-top{padding-top:6px}
@media(max-width:360px){.hc-btn{padding:8px 4px;font-size:10px}.hc-btn .ico{font-size:16px}}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- HEADER -->
<div class="hdr">
  <div class="logo"><div class="logo-mark">N</div>NGTZ</div>
  <div class="hdr-actions">
    <button class="hdr-btn" onclick="exportData()">‚Üì</button>
    <button class="hdr-btn" onclick="importData()">‚Üë</button>
  </div>
</div>

<!-- ===== VIEW: TODAY ===== -->
<div id="v-today" class="vw act">
  <div class="lvl-bar" id="lvl-bar"></div>
  <div id="moment-prompt-area"></div>
  <div class="score-sec">
    <div class="score-wrap">
      <svg class="score-ring" viewBox="0 0 120 120"><circle class="bg" cx="60" cy="60" r="52"/><circle class="prog" id="s-prog" cx="60" cy="60" r="52" stroke-dasharray="326.73" stroke-dashoffset="326.73" transform="rotate(-90 60 60)"/></svg>
      <div class="score-val" id="s-val">0%</div>
    </div>
    <div class="score-lbl" id="s-lbl">TODAY'S SCORE</div>
  </div>
  <div class="week-strip" id="week-strip"></div>
  <div class="date-nav">
    <button class="dn-btn" onclick="chgDate(-1)">‚Äπ</button>
    <div class="dn-center"><div class="dn-main" id="d-main"></div><div class="dn-sub" id="d-sub"></div></div>
    <button class="dn-btn" onclick="chgDate(1)">‚Ä∫</button>
    <button class="dn-today" onclick="goToday()">Today</button>
  </div>
  <div id="warn-area"></div>
  <div id="mood-area"></div>
  <div class="sec" id="habits-list"></div>
</div>

<!-- ===== VIEW: VISION ===== -->
<div id="v-vision" class="vw">
  <div class="pad-top"></div>
  <div class="sec" id="vision-area"></div>
</div>

<!-- ===== VIEW: STATS ===== -->
<div id="v-stats" class="vw">
  <div class="pad-top"></div>
  <div class="stats-row" id="stats-row"></div>
  <div class="sec" style="margin-top:16px"><div class="sec-hdr"><span class="sec-ttl">Mood & Habits Correlation</span></div><div id="mood-chart-area"></div></div>
  <div class="sec"><div class="sec-hdr"><span class="sec-ttl">Milestones</span></div><div class="ms-list" id="ms-list"></div></div>
  <div class="sec"><div class="sec-hdr"><span class="sec-ttl">Weekly Report</span><span id="wr-week" style="font-size:12px;color:var(--tm)"></span></div><div id="wr-area"></div></div>
  <div class="sec"><div class="sec-hdr"><span class="sec-ttl">Memorable Moments</span></div><div id="moments-timeline"></div></div>
  <div class="sec"><div class="sec-hdr"><span class="sec-ttl">This Month</span><span id="ch-mo" style="font-size:12px;color:var(--tm)"></span></div><div class="chart-wrap" id="mo-chart"></div></div>
  <div class="sec" id="hm-sec"><div class="sec-hdr"><span class="sec-ttl">Heatmaps</span></div></div>
</div>

<!-- ===== VIEW: SETTINGS ===== -->
<div id="v-settings" class="vw">
  <div class="pad-top"></div>
  <div class="sec"><div class="sec-hdr"><span class="sec-ttl">Your Habits</span></div><div id="set-habits"></div></div>
  <div class="sec">
    <div class="sec-hdr"><span class="sec-ttl">Reminder Tips</span></div>
    <div style="background:var(--s1);border:1px solid var(--brd);border-radius:var(--rad);padding:14px;">
      <p style="font-size:13px;color:var(--td);line-height:1.7">üì± Set alarms in your Clock app:<br>‚Ä¢ <strong>7:30 AM</strong> ‚Äî "Log yesterday's moment ‚ú®"<br>‚Ä¢ <strong>9:00 PM</strong> ‚Äî "Log your habits üìä"<br>‚Ä¢ <strong>10:00 PM</strong> ‚Äî "Rate your day üåô"</p>
    </div>
  </div>
  <div class="sec"><div class="sec-hdr"><span class="sec-ttl">Data</span></div><button class="btn-d" onclick="if(confirm('Reset ALL data? Cannot be undone.')){localStorage.clear();location.reload()}">‚ö† Reset All Data</button></div>
  <div class="sec" style="text-align:center;padding:20px 18px 40px"><p style="font-size:11px;color:var(--tm)">NGTZ Tracker v3.0</p><p style="font-size:10px;color:var(--tm);margin-top:3px">Never Go To Zero ¬∑ Built with intention</p></div>
</div>

<!-- FAB -->
<button class="fab" id="fab" onclick="openAdd()">+</button>

<!-- MODAL: HABIT -->
<div class="mo" id="mo-habit">
  <div class="mo-c">
    <div class="mo-handle"></div>
    <h2 id="mh-title">New Habit</h2>
    <div class="fg"><label class="fl">Habit Name</label><input class="fi" id="f-name" placeholder="e.g. Reading"></div>
    <div class="fg">
      <label class="fl">Category</label>
      <select class="fsel" id="f-cat">
        <option value="core">üîí Core ‚Äî Non-negotiable</option>
        <option value="growth">‚≠ê Growth ‚Äî Building up</option>
        <option value="shield">üõ°Ô∏è Shield ‚Äî Eliminating</option>
      </select>
    </div>
    <div id="f-green-group" class="fg"><label class="fl">üü¢ Green ‚Äî Ideal Day (V1.0)</label><input class="fi" id="f-green" placeholder="e.g. Read for 1 hour"></div>
    <div id="f-yellow-group" class="fg"><label class="fl">üü° Yellow ‚Äî Non-Zero Day (V0.1)</label><input class="fi" id="f-yellow" placeholder="e.g. Read 10 pages"></div>
    <div id="f-shield-labels" style="display:none">
      <div class="fg"><label class="fl">üü¢ Green ‚Äî Didn't do it (Victory!)</label><input class="fi" id="f-green-s" placeholder="e.g. No snacking"></div>
      <div class="fg"><label class="fl">üü° Yellow ‚Äî Did it, but controlled</label><input class="fi" id="f-yellow-s" placeholder="e.g. 1 small snack"></div>
    </div>
    <div class="fr">
      <div class="fg"><label class="fl">Times / Week</label><select class="fsel" id="f-freq"><option value="7">7√ó Daily</option><option value="6">6√ó</option><option value="5">5√ó</option><option value="4">4√ó</option><option value="3">3√ó</option><option value="2">2√ó</option><option value="1">1√ó</option></select></div>
      <div class="fg"><label class="fl">Free Days</label><select class="fsel" id="f-free"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div>
    </div>
    <button class="btn-p" id="btn-save" onclick="saveHabit()">Create Habit</button>
    <button class="btn-d" id="btn-del" style="display:none" onclick="delHabit()">Delete Habit</button>
    <button class="btn-c" onclick="closeMo('mo-habit')">Cancel</button>
  </div>
</div>

<!-- MODAL: VISION -->
<div class="mo" id="mo-vision">
  <div class="mo-c">
    <div class="mo-handle"></div>
    <h2>My 2026 Vision</h2>
    <p style="font-size:12px;color:var(--tm);margin-bottom:14px">The 5 Wealth Framework ‚Äî Sahil Bloom</p>
    <div class="fg"><label class="fl">‚è≥ Time Wealth</label><input class="fi" id="vg-time" placeholder="How I want to spend my time..."></div>
    <div class="fg"><label class="fl">üë• Social Wealth</label><input class="fi" id="vg-social" placeholder="The relationships I'm building..."></div>
    <div class="fg"><label class="fl">üß† Mental Wealth</label><input class="fi" id="vg-mental" placeholder="How I'm growing my mind..."></div>
    <div class="fg"><label class="fl">üí™ Physical Wealth</label><input class="fi" id="vg-physical" placeholder="How I'm caring for my body..."></div>
    <div class="fg"><label class="fl">üí∞ Financial Wealth</label><input class="fi" id="vg-financial" placeholder="My financial goals..."></div>
    <button class="btn-p" onclick="saveVision()">Save Vision</button>
    <button class="btn-c" onclick="closeMo('mo-vision')">Cancel</button>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bnav">
  <button class="bnav-i act" onclick="navTo('today',this)"><span class="bnav-ico">‚óâ</span>Today</button>
  <button class="bnav-i" onclick="navTo('vision',this)"><span class="bnav-ico">‚ú¶</span>Vision</button>
  <button class="bnav-i" onclick="navTo('stats',this)"><span class="bnav-ico">‚ó´</span>Stats</button>
  <button class="bnav-i" onclick="navTo('settings',this)"><span class="bnav-ico">‚öô</span>Settings</button>
</div>

<script>
// ============================= DATA =============================
const SK='ngtz3';
let D=load();let curDate=new Date();let editId=null;
function load(){try{const r=localStorage.getItem(SK);if(r)return JSON.parse(r)}catch(e){}return{habits:[],entries:{},xp:0,milestones:[],vision:{},moments:{},mood:{}}}
function save(){localStorage.setItem(SK,JSON.stringify(D))}
function dk(d){const t=d instanceof Date?d:new Date(d);return t.getFullYear()+'-'+S(t.getMonth()+1)+'-'+S(t.getDate())}
function S(n){return String(n).padStart(2,'0')}
function todayDk(){return dk(new Date())}
function isToday(d){return dk(d)===todayDk()}
function getE(hid,k){return D.entries[k]?.[hid]||null}
function setE(hid,k,s){if(!D.entries[k])D.entries[k]={};D.entries[k][hid]=s;save()}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// ============================= XP & LEVELS =============================
const LEVELS=[{n:'Starter',x:0},{n:'Builder',x:100},{n:'Consistent',x:300},{n:'Focused',x:600},{n:'Machine',x:1000},{n:'Relentless',x:1600},{n:'Unstoppable',x:2500},{n:'Elite',x:4000},{n:'Legend',x:6000},{n:'NGTZ Master',x:10000}];
function getLvl(){let l=0;for(let i=LEVELS.length-1;i>=0;i--)if(D.xp>=LEVELS[i].x){l=i;break}return l}
function getLvlInfo(){const l=getLvl(),c=LEVELS[l],nx=LEVELS[l+1]||{x:c.x+1000};return{level:l+1,name:c.n,xp:D.xp,nextXp:nx.x,pct:Math.min(100,(D.xp-c.x)/(nx.x-c.x)*100)}}
function addXP(a,r){D.xp+=a;save();toast((a>0?'+':'')+a+' XP ‚Äî '+r,'tg')}

// ============================= STREAKS =============================
function getStreak(hid){const h=D.habits.find(x=>x.id===hid);if(!h)return 0;let s=0,d=new Date();if(!getE(hid,dk(d)))d.setDate(d.getDate()-1);for(let i=0;i<365;i++){const k=dk(d),e=getE(hid,k);if(e==='green'||e==='yellow'||e==='rest')s++;else break;d.setDate(d.getDate()-1)}return s}
function bestStreak(hid){let b=0,c=0,d=new Date();for(let i=0;i<365;i++){const k=dk(d),e=getE(hid,k);if(e==='green'||e==='yellow'||e==='rest'){c++;b=Math.max(b,c)}else c=0;d.setDate(d.getDate()-1)}return b}
function streakMsg(s){if(s<3)return'Building...';if(s<7)return'Momentum! üí™';if(s<14)return'On fire!';if(s<21)return'Impressive! üî•';if(s<30)return'Habit forming!';if(s<66)return'Unstoppable!';return'This is you now. üíé'}

// ============================= WEEKLY FLEX =============================
function getWeekStart(d){const t=new Date(d);const day=t.getDay();t.setDate(t.getDate()-(day===0?6:day-1));t.setHours(0,0,0,0);return t}
function getWeekEnd(d){const s=getWeekStart(d);s.setDate(s.getDate()+6);return s}
function getWeeklyStatus(hid,ref){
  const h=D.habits.find(x=>x.id===hid);if(!h)return{done:0,target:7,daysLeft:0,remaining:0,status:'ok'};
  const ws=getWeekStart(ref),target=parseInt(h.freq);let done=0;
  for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(d.getDate()+i);const e=getE(hid,dk(d));if(e==='green'||e==='yellow')done++}
  const we=getWeekEnd(ref),rd=new Date(ref);rd.setHours(0,0,0,0);
  const daysLeft=Math.floor((we-rd)/864e5)+1;
  const remaining=Math.max(0,target-done);
  let status='ok';if(remaining<=0)status='done';else if(remaining>=daysLeft)status='crit';else if(remaining>=daysLeft-1)status='warn';
  return{done,target,daysLeft,remaining,status}
}

// ============================= SCORING =============================
function dayScore(k){let pts=0,max=0;D.habits.forEach(h=>{const e=getE(h.id,k);if(e==='rest')return;max+=2;if(e==='green')pts+=2;else if(e==='yellow')pts+=1});return{pts,max,pct:max?Math.round(pts/max*100):0}}

// ============================= MILESTONES =============================
const MDEFS=[
  {id:'first_green',ico:'üå±',name:'First Green',check:()=>{let f=false;Object.values(D.entries).forEach(d=>{Object.entries(d).forEach(([k,v])=>{if(!k.startsWith('_')&&v==='green')f=true})});return f}},
  {id:'streak_7',ico:'üî•',name:'7-Day Fire',check:()=>D.habits.some(h=>getStreak(h.id)>=7)},
  {id:'streak_21',ico:'‚ö°',name:'21-Day Habit',check:()=>D.habits.some(h=>getStreak(h.id)>=21)},
  {id:'streak_66',ico:'üíé',name:'66-Day Diamond',check:()=>D.habits.some(h=>getStreak(h.id)>=66)},
  {id:'xp_500',ico:'‚≠ê',name:'500 XP',check:()=>D.xp>=500},
  {id:'xp_2000',ico:'üèÜ',name:'2000 XP',check:()=>D.xp>=2000},
  {id:'perfect_day',ico:'üëë',name:'Perfect Day',check:()=>Object.entries(D.entries).some(([k,ents])=>{const vals=Object.entries(ents).filter(([ek])=>!ek.startsWith('_')).map(([,v])=>v);return vals.length>0&&vals.length===D.habits.length&&vals.every(v=>v==='green'||v==='rest')})},
  {id:'lvl5',ico:'üöÄ',name:'Level 5',check:()=>getLvl()>=4},
  {id:'ten_habits',ico:'üéØ',name:'Full Stack',check:()=>D.habits.length>=10},
  {id:'moments_7',ico:'üìñ',name:'7 Moments',check:()=>Object.keys(D.moments).length>=7},
  {id:'vision_set',ico:'üî≠',name:'Visionary',check:()=>Object.values(D.vision).some(v=>v)},
];
function checkMilestones(){MDEFS.forEach(m=>{if(!D.milestones.includes(m.id)&&m.check()){D.milestones.push(m.id);save();toast('üèÖ '+m.name+'!','tg')}})}

// ============================= NAVIGATION =============================
function navTo(v,el){
  document.querySelectorAll('.vw').forEach(x=>x.classList.remove('act'));
  document.getElementById('v-'+v).classList.add('act');
  document.querySelectorAll('.bnav-i').forEach(x=>x.classList.remove('act'));
  if(el)el.classList.add('act');
  document.getElementById('fab').style.display=v==='today'?'flex':'none';
  if(v==='stats')renderStats();
  if(v==='settings')renderSettings();
  if(v==='vision')renderVision();
}
function chgDate(d){curDate.setDate(curDate.getDate()+d);renderToday()}
function goToday(){curDate=new Date();renderToday()}

// ============================= RENDER: TODAY =============================
function renderToday(){
  const k=dk(curDate);
  const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('d-main').textContent=days[curDate.getDay()]+', '+mos[curDate.getMonth()]+' '+curDate.getDate();
  document.getElementById('d-sub').textContent=isToday(curDate)?'Today':curDate.getFullYear();

  // Level
  const li=getLvlInfo();
  document.getElementById('lvl-bar').innerHTML=`<div class="lvl-badge"><div class="lvl-num">${li.level}</div><div class="lvl-lbl">LVL</div></div><div class="lvl-info"><div class="lvl-title">${li.name}</div><div class="lvl-xp-text">${D.xp} / ${li.nextXp} XP</div><div class="lvl-xp-track"><div class="lvl-xp-fill" style="width:${li.pct}%"></div></div></div>`;

  // Score ring
  const{pts,max,pct}=dayScore(k);
  const ci=document.getElementById('s-prog');
  ci.style.strokeDashoffset=326.73-(326.73*pct/100);
  ci.style.stroke=pct>=70?'var(--g)':pct>=40?'var(--y)':pct>0?'var(--r)':'var(--s3)';
  document.getElementById('s-val').textContent=pct+'%';
  document.getElementById('s-lbl').textContent=max>0?pts+' / '+max+' PTS':'NO HABITS ACTIVE';

  renderWeek();
  renderWarnings();
  renderMomentPrompt();
  renderMoodInput();
  renderHabitCards();
}

function renderWeek(){
  const ct=document.getElementById('week-strip');const labels=['M','T','W','T','F','S','S'];const ws=getWeekStart(curDate);let h='';
  for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(d.getDate()+i);const{pct}=dayScore(dk(d));let c=pct>=70?'g':pct>=30?'y':pct>0?'r':'';if(isToday(d))c+=' today';h+=`<div class="ws-day"><span class="ws-lbl">${labels[i]}</span><div class="ws-dot ${c}">${d.getDate()}</div></div>`}
  ct.innerHTML=h;
}

function renderWarnings(){
  const area=document.getElementById('warn-area');
  if(!isToday(curDate)||D.habits.length===0){area.innerHTML='';return}
  let crit=[],warn=[];
  D.habits.forEach(h=>{const ws=getWeeklyStatus(h.id,curDate);if(ws.status==='crit')crit.push(h.name);else if(ws.status==='warn')warn.push(h.name)});
  let html='';
  if(crit.length)html+=`<div class="warn-banner urgent">üö® ${crit.join(', ')} ‚Äî NON-NEGOTIABLE today</div>`;
  if(warn.length)html+=`<div class="warn-banner caution">‚ö†Ô∏è ${warn.join(', ')} ‚Äî running tight this week</div>`;
  area.innerHTML=html;
}

// ============================= MEMORABLE MOMENT PROMPT =============================
function renderMomentPrompt(){
  const area=document.getElementById('moment-prompt-area');
  if(!isToday(curDate)){area.innerHTML='';return}
  // Check if yesterday's moment exists
  const yd=new Date();yd.setDate(yd.getDate()-1);const ydk=dk(yd);
  if(D.moments[ydk]){area.innerHTML='';return}
  // Show prompt
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  area.innerHTML=`<div class="prompt-card">
    <div class="prompt-title">‚ú® Before you start ‚Äî what was yesterday's best moment? <span style="font-weight:400;color:var(--tm)">(${mos[yd.getMonth()]} ${yd.getDate()})</span></div>
    <textarea class="prompt-input" id="moment-input" placeholder="That one thing that made yesterday worth it..."></textarea>
    <button class="prompt-save" onclick="saveMoment('${ydk}')">Save moment</button>
  </div>`;
}
function saveMoment(k){
  const v=document.getElementById('moment-input').value.trim();
  if(!v)return;
  D.moments[k]=v;save();
  renderMomentPrompt();
  addXP(3,'Moment captured ‚ú®');
  checkMilestones();
}

// ============================= MOOD / STRESS INPUT =============================
function renderMoodInput(){
  const area=document.getElementById('mood-area');
  const k=dk(curDate);
  const existing=D.mood[k]||{};
  const moods=['üò´','üòï','üòê','üôÇ','üòÑ'];
  const stress=['üî¥','üü†','üü°','üü¢','üíö'];

  area.innerHTML=`<div class="prompt-card" style="border-color:var(--brd)">
    <div class="prompt-title">How was this day?</div>
    <div class="prompt-row"><span class="prompt-lbl">Mood</span>${moods.map((m,i)=>`<button class="mood-btn ${existing.mood===i?'sel':''}" onclick="setMood('${k}','mood',${i})">${m}</button>`).join('')}</div>
    <div class="prompt-row" style="margin-top:6px"><span class="prompt-lbl">Stress</span>${stress.map((s,i)=>`<button class="mood-btn ${existing.stress===i?'sel':''}" onclick="setMood('${k}','stress',${i})">${s}</button>`).join('')}</div>
  </div>`;
}
function setMood(k,type,val){
  if(!D.mood[k])D.mood[k]={};
  D.mood[k][type]=val;save();renderMoodInput();
}

// ============================= HABIT CARDS =============================
function renderHabitCards(){
  const ct=document.getElementById('habits-list');const k=dk(curDate);
  if(D.habits.length===0){ct.innerHTML=`<div class="empty"><div class="empty-ico">üéØ</div><div class="empty-ttl">No habits yet</div><div class="empty-txt">Tap + to create your first habit.<br>Never Go To Zero!</div></div>`;return}

  const cats=[{key:'core',label:'üîí Core ‚Äî Non-negotiable',habits:[]},{key:'growth',label:'‚≠ê Growth ‚Äî Building up',habits:[]},{key:'shield',label:'üõ°Ô∏è Shield ‚Äî Eliminating',habits:[]}];
  D.habits.forEach(h=>{const c=cats.find(c=>c.key===(h.cat||'growth'));if(c)c.habits.push(h);else cats[1].habits.push(h)});

  let html='';
  cats.forEach(cat=>{
    if(cat.habits.length===0)return;
    html+=`<div class="cat-divider">${cat.label}</div>`;
    cat.habits.forEach(h=>{
      const e=getE(h.id,k);const streak=getStreak(h.id);const ws=getWeeklyStatus(h.id,curDate);
      const sc=e?'st-'+(e==='rest'?'rest':e):'st-n';
      const isShield=h.cat==='shield';

      // Weekly pips
      const weekStart=getWeekStart(curDate);let pips='';
      for(let i=0;i<7;i++){const pd=new Date(weekStart);pd.setDate(pd.getDate()+i);const pe=getE(h.id,dk(pd));pips+=`<div class="hc-pip ${pe==='green'?'g':pe==='yellow'?'y':pe==='red'?'r':''}"></div>`}

      let tagCls='ok',tagText=ws.remaining+' left ¬∑ '+ws.daysLeft+'d';
      if(ws.status==='done'){tagCls='done';tagText='‚úì Done this week'}
      else if(ws.status==='crit'){tagCls='crit';tagText='NON-NEGOTIABLE ¬∑ '+ws.remaining+' in '+ws.daysLeft+'d'}
      else if(ws.status==='warn'){tagCls='warn';tagText=ws.remaining+' left ¬∑ '+ws.daysLeft+'d ‚ö†Ô∏è'}

      const noteVal=D.entries[k]?.['_note_'+h.id]||'';

      // Shield framing: green = didn't do it, red = fell into it
      const greenLabel=isShield?'Clean':'V1.0';
      const yellowLabel=isShield?'Controlled':'V0.1';
      const redLabel=isShield?'Fell':'Zero';
      const metaText=e==='green'?'üü¢ '+esc(h.greenDesc):e==='yellow'?'üü° '+esc(h.yellowDesc):e==='red'?(isShield?'üî¥ Lost control':'üî¥ Went to zero'):e==='rest'?'üòé Rest day':'Not logged';

      html+=`<div class="hc ${sc}">
        <div class="hc-top"><div><div class="hc-name">${esc(h.name)} <span class="hc-cat ${h.cat||'growth'}">${h.cat==='core'?'üîí CORE':h.cat==='shield'?'üõ°Ô∏è SHIELD':'‚≠ê GROWTH'}</span></div><div class="hc-meta">${metaText}</div></div>
        <div class="hc-streak ${streak>0?'on':''}">${streak>0?'üî•':'‚òÅÔ∏è'} ${streak>0?streak+'d ¬∑ '+streakMsg(streak):'New streak: Day 1 üå±'}</div></div>
        <div class="hc-weekly"><span class="hc-weekly-tag ${tagCls}">${tagText}</span><span style="font-size:10px;color:var(--tm)">${ws.done}/${ws.target}</span><div class="hc-weekly-pips">${pips}</div></div>
        <div class="hc-actions">
          <button class="hc-btn ${e==='green'?'g-sel':''}" onclick="logH('${h.id}','${k}','green')"><span class="ico">üü¢</span>${greenLabel}</button>
          <button class="hc-btn ${e==='yellow'?'y-sel':''}" onclick="logH('${h.id}','${k}','yellow')"><span class="ico">üü°</span>${yellowLabel}</button>
          <button class="hc-btn ${e==='red'?'r-sel':''}" onclick="logH('${h.id}','${k}','red')"><span class="ico">üî¥</span>${redLabel}</button>
          ${parseInt(h.freeDays||0)>0?`<button class="hc-btn ${e==='rest'?'rest-sel':''}" onclick="logH('${h.id}','${k}','rest')"><span class="ico">üòé</span>Rest</button>`:''}
        </div>
        <button class="hc-note-toggle" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">+ note</button>
        <div class="hc-note-area" style="display:${noteVal?'block':'none'}"><textarea class="hc-note-input" placeholder="Add a note..." onchange="saveNote('${h.id}','${k}',this.value)">${esc(noteVal)}</textarea></div>
      </div>`
    });
  });
  ct.innerHTML=html;
}

function logH(hid,k,status){
  const prev=getE(hid,k);
  if(prev===status){if(D.entries[k])delete D.entries[k][hid];if(prev==='green')D.xp=Math.max(0,D.xp-10);else if(prev==='yellow')D.xp=Math.max(0,D.xp-5);save()}
  else{if(prev==='green')D.xp=Math.max(0,D.xp-10);else if(prev==='yellow')D.xp=Math.max(0,D.xp-5);setE(hid,k,status);if(status==='green')addXP(10,'Green day!');else if(status==='yellow')addXP(5,'Non-zero!');else if(status==='red')toast('Bounce back tomorrow üí™','tr');else if(status==='rest')toast('üòé Recharging','ty')}
  checkMilestones();renderToday();
}
function saveNote(hid,k,val){if(!D.entries[k])D.entries[k]={};D.entries[k]['_note_'+hid]=val;save()}

// ============================= VISION BOARD =============================
const WEALTH_TYPES=[{key:'time',ico:'‚è≥',label:'Time Wealth'},{key:'social',ico:'üë•',label:'Social Wealth'},{key:'mental',ico:'üß†',label:'Mental Wealth'},{key:'physical',ico:'üí™',label:'Physical Wealth'},{key:'financial',ico:'üí∞',label:'Financial Wealth'}];
function renderVision(){
  const area=document.getElementById('vision-area');
  const hasVision=Object.values(D.vision||{}).some(v=>v);
  let html=`<div class="vision-card"><div class="vision-title">üî≠ My 2026 Vision</div>`;
  if(hasVision){
    WEALTH_TYPES.forEach(w=>{
      const val=D.vision[w.key]||'';
      if(val)html+=`<div class="vision-goal"><div class="vision-ico">${w.ico}</div><div><div class="vision-type">${w.label}</div><div class="vision-text">${esc(val)}</div></div></div>`;
    });
  }else{
    html+=`<div class="vision-empty">Define your vision across the 5 types of wealth.<br>What does your ideal 2026 look like?</div>`;
  }
  html+=`<button class="vision-edit-btn" onclick="openVisionEdit()">‚úèÔ∏è ${hasVision?'Edit':'Set'} Vision</button></div>`;
  area.innerHTML=html;
}
function openVisionEdit(){
  WEALTH_TYPES.forEach(w=>{document.getElementById('vg-'+w.key).value=D.vision[w.key]||''});
  openMo('mo-vision');
}
function saveVision(){
  WEALTH_TYPES.forEach(w=>{D.vision[w.key]=document.getElementById('vg-'+w.key).value.trim()});
  save();closeMo('mo-vision');renderVision();checkMilestones();toast('Vision saved ‚ú®','tg');
}

// ============================= RENDER: STATS =============================
function renderStats(){
  let greens=0,yellows=0,reds=0;
  Object.values(D.entries).forEach(d=>{Object.entries(d).forEach(([k,v])=>{if(k.startsWith('_'))return;if(v==='green')greens++;else if(v==='yellow')yellows++;else if(v==='red')reds++})});
  const total=greens+yellows+reds;const overall=total?Math.round((greens*2+yellows)/(total*2)*100):0;
  let bestS=0;D.habits.forEach(h=>{bestS=Math.max(bestS,bestStreak(h.id))});
  // Non-zero days (consistency focus): days where at least one entry was green or yellow
  const nzDays=Object.entries(D.entries).filter(([,ents])=>Object.entries(ents).some(([k,v])=>!k.startsWith('_')&&(v==='green'||v==='yellow'))).length;

  document.getElementById('stats-row').innerHTML=`
    <div class="st-card"><div class="st-val grad">${overall}%</div><div class="st-lbl">Overall</div></div>
    <div class="st-card"><div class="st-val grad">${nzDays}</div><div class="st-lbl">Non-Zero Days</div></div>
    <div class="st-card"><div class="st-val g">${greens}</div><div class="st-lbl">Greens</div></div>
    <div class="st-card"><div class="st-val y">${yellows}</div><div class="st-lbl">Yellows</div></div>
    <div class="st-card"><div class="st-val r">${reds}</div><div class="st-lbl">Reds</div></div>
    <div class="st-card"><div class="st-val grad">${bestS}d</div><div class="st-lbl">Best Streak</div></div>
    <div class="st-card"><div class="st-val grad">${D.xp}</div><div class="st-lbl">Total XP</div></div>`;

  renderMoodChart();
  renderMilestones();
  renderWeeklyReport();
  renderMomentsTimeline();
  renderMonthChart();
  renderHeatmaps();
}

// ============================= MOOD CHART =============================
function renderMoodChart(){
  const area=document.getElementById('mood-chart-area');
  const entries=Object.entries(D.mood).sort((a,b)=>a[0].localeCompare(b[0])).slice(-30);
  if(entries.length<2){area.innerHTML=`<div class="mood-chart-wrap"><div class="mood-chart-title">Mood & Stress vs Habits</div><p style="font-size:12px;color:var(--tm);padding:20px 0;text-align:center">Log at least 2 days of mood data to see the chart.</p></div>`;return}

  const w=320,h=130,padL=28,padR=10,padT=10,padB=24;
  const plotW=w-padL-padR,plotH=h-padT-padB;
  const n=entries.length;const gap=plotW/(n-1);

  function yPos(val,max){return padT+plotH-(val/max*plotH)}

  let moodPath='',stressPath='',habitPath='';
  let moodDots='',stressDots='',habitBars='';

  entries.forEach(([k,m],i)=>{
    const x=padL+i*gap;
    const moodY=yPos(m.mood!==undefined?m.mood:2,4);
    const stressY=yPos(m.stress!==undefined?m.stress:2,4);
    const{pct}=dayScore(k);
    const habitY=yPos(pct,100);

    // Bars for habit %
    const barH=padT+plotH-habitY;
    habitBars+=`<rect x="${x-3}" y="${habitY}" width="6" height="${barH}" rx="2" fill="var(--g)" opacity=".15"/>`;

    // Paths
    moodPath+=(i===0?'M':'L')+x+','+moodY;
    stressPath+=(i===0?'M':'L')+x+','+stressY;

    moodDots+=`<circle cx="${x}" cy="${moodY}" r="3" fill="var(--g)"/>`;
    stressDots+=`<circle cx="${x}" cy="${stressY}" r="3" fill="var(--r)"/>`;
  });

  const svg=`<svg viewBox="0 0 ${w} ${h}" class="mood-chart-svg" preserveAspectRatio="none">
    <!-- Grid -->
    <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${padT+plotH}" stroke="var(--s3)" stroke-width=".5"/>
    <line x1="${padL}" y1="${padT+plotH}" x2="${w-padR}" y2="${padT+plotH}" stroke="var(--s3)" stroke-width=".5"/>
    <!-- Habit bars -->
    ${habitBars}
    <!-- Mood line -->
    <path d="${moodPath}" fill="none" stroke="var(--g)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    ${moodDots}
    <!-- Stress line -->
    <path d="${stressPath}" fill="none" stroke="var(--r)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4 3"/>
    ${stressDots}
    <!-- Labels -->
    <text x="${padL-4}" y="${padT+4}" font-size="7" fill="var(--tm)" text-anchor="end">High</text>
    <text x="${padL-4}" y="${padT+plotH}" font-size="7" fill="var(--tm)" text-anchor="end">Low</text>
  </svg>`;

  area.innerHTML=`<div class="mood-chart-wrap">
    <div class="mood-chart-title">Mood & Stress vs Habits (last ${entries.length} days)</div>
    ${svg}
    <div class="mood-legend">
      <div class="mood-legend-item"><div class="mood-legend-dot" style="background:var(--g)"></div>Mood</div>
      <div class="mood-legend-item"><div class="mood-legend-dot" style="background:var(--r)"></div>Stress</div>
      <div class="mood-legend-item"><div class="mood-legend-dot" style="background:var(--g);opacity:.2"></div>Habit %</div>
    </div>
  </div>`;
}

function renderMilestones(){
  document.getElementById('ms-list').innerHTML=MDEFS.map(m=>`<div class="ms-badge ${D.milestones.includes(m.id)?'unlocked':'locked'}"><div class="ms-ico">${m.ico}</div><div class="ms-name">${m.name}</div></div>`).join('');
}

function renderWeeklyReport(){
  const today=new Date();const lm=getWeekStart(today);lm.setDate(lm.getDate()-7);const ls=new Date(lm);ls.setDate(ls.getDate()+6);
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('wr-week').textContent=mos[lm.getMonth()]+' '+lm.getDate()+' ‚Äì '+mos[ls.getMonth()]+' '+ls.getDate();
  let g=0,y=0,r=0,total=0,hs={};
  for(let i=0;i<7;i++){const d=new Date(lm);d.setDate(d.getDate()+i);const k=dk(d);D.habits.forEach(h=>{const e=getE(h.id,k);if(!e||e==='rest')return;total++;if(e==='green'){g++;hs[h.name]=(hs[h.name]||0)+2}else if(e==='yellow'){y++;hs[h.name]=(hs[h.name]||0)+1}else{r++; hs[h.name]=(hs[h.name]||0)+0}})}
  const pct=total?Math.round((g*2+y)/(total*2)*100):0;
  const entries=Object.entries(hs);let bestH='‚Äî',worstH='‚Äî';
  if(entries.length){entries.sort((a,b)=>b[1]-a[1]);bestH=entries[0][0];worstH=entries[entries.length-1][0]}
  let msg=pct>=90?'"You don\'t rise to the level of your goals. You fall to the level of your systems." üèÜ':pct>=70?'"Consistency beats intensity." ‚Äî Solid week. üí™':pct>=50?'"A yellow day beats a zero day." ‚Äî Room to grow. üü°':pct>0?'"The only bad week is one where you stopped tracking." ‚Äî You didn\'t. üõ°Ô∏è':'"Every master was once a disaster." ‚Äî Start now. üå±';
  document.getElementById('wr-area').innerHTML=`<div class="wr-card"><div class="wr-title">üìä Weekly Scorecard</div><div class="wr-grid"><div class="wr-item"><div class="wr-item-val" style="color:var(--g)">${pct}%</div><div class="wr-item-lbl">Score</div></div><div class="wr-item"><div class="wr-item-val">${g}<span style="font-size:12px;color:var(--tm)"> / ${y} / ${r}</span></div><div class="wr-item-lbl">G / Y / R</div></div><div class="wr-item"><div class="wr-item-val" style="font-size:14px;color:var(--g)">${bestH}</div><div class="wr-item-lbl">Best Habit</div></div><div class="wr-item"><div class="wr-item-val" style="font-size:14px;color:var(--y)">${worstH}</div><div class="wr-item-lbl">Needs Love</div></div></div><div class="wr-msg">${msg}</div></div>`;
}

// ============================= MOMENTS TIMELINE =============================
function renderMomentsTimeline(){
  const ct=document.getElementById('moments-timeline');
  const entries=Object.entries(D.moments).sort((a,b)=>b[0].localeCompare(a[0])).slice(0,20);
  if(entries.length===0){ct.innerHTML=`<p style="font-size:12px;color:var(--tm);text-align:center;padding:16px 0">No moments captured yet. They'll appear here as you log them each morning.</p>`;return}
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  ct.innerHTML=entries.map(([k,v])=>{
    const d=new Date(k+'T12:00:00');
    const moodData=D.mood[k]||{};
    const moods=['üò´','üòï','üòê','üôÇ','üòÑ'];
    const stress=['üî¥','üü†','üü°','üü¢','üíö'];
    const moodEmoji=moodData.mood!==undefined?moods[moodData.mood]:'';
    const stressEmoji=moodData.stress!==undefined?stress[moodData.stress]:'';
    return`<div class="moment-item"><div class="moment-date">${mos[d.getMonth()]} ${d.getDate()}</div><div class="moment-text">${esc(v)}</div><div class="moment-mood">${moodEmoji}${stressEmoji}</div></div>`
  }).join('');
}

function renderMonthChart(){
  const now=new Date(),yr=now.getFullYear(),mo=now.getMonth();const dim=new Date(yr,mo+1,0).getDate();
  const mos=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('ch-mo').textContent=mos[mo]+' '+yr;
  let h='<div class="chart-bars">';
  for(let d=1;d<=dim;d++){const k=dk(new Date(yr,mo,d));const{pct}=dayScore(k);const c=pct>=70?'g':pct>=30?'y':pct>0?'r':'';h+=`<div class="cb-grp"><div class="cb-bar ${c}" style="height:${Math.max(pct,1)}%"></div>${d%5===1?`<span class="cb-lbl">${d}</span>`:''}</div>`}
  document.getElementById('mo-chart').innerHTML=h+'</div>';
}

function renderHeatmaps(){
  const ct=document.getElementById('hm-sec');let html='<div class="sec-hdr"><span class="sec-ttl">Heatmaps</span></div>';
  if(!D.habits.length){ct.innerHTML=html;return}
  D.habits.forEach(h=>{
    html+=`<div class="hm-card"><div class="hm-ttl">${esc(h.name)}</div><div class="hm-sub">üî• ${getStreak(h.id)}d ¬∑ Best: ${bestStreak(h.id)}d</div><div class="hm-grid">`;
    ['M','T','W','T','F','S','S'].forEach(d=>{html+=`<div class="hm-dlbl">${d}</div>`});
    const today=new Date(),start=new Date(today);start.setDate(start.getDate()-34);
    const dow=start.getDay();start.setDate(start.getDate()-(dow===0?6:dow-1));
    for(let i=0;i<42;i++){const d=new Date(start);d.setDate(d.getDate()+i);const k2=dk(d);const e=getE(h.id,k2);const isFut=d>today;let cls=isFut?'future':e==='rest'?'rest-c':(e||'');if(isToday(d))cls+=' today';html+=`<div class="hm-cell ${cls}"></div>`}
    html+='</div></div>';
  });
  ct.innerHTML=html;
}

// ============================= SETTINGS =============================
function renderSettings(){
  const ct=document.getElementById('set-habits');
  if(!D.habits.length){ct.innerHTML='<p style="font-size:13px;color:var(--tm)">No habits yet.</p>';return}
  const catLabel={core:'üîí Core',growth:'‚≠ê Growth',shield:'üõ°Ô∏è Shield'};
  ct.innerHTML=D.habits.map(h=>`<div class="set-item"><div><div class="set-name">${esc(h.name)} <span class="hc-cat ${h.cat||'growth'}" style="font-size:9px">${catLabel[h.cat||'growth']}</span></div><div class="set-sub">${h.freq}√ó/wk ¬∑ üî• ${getStreak(h.id)}d</div></div><button class="set-edit" onclick="openEdit('${h.id}')">Edit</button></div>`).join('');
}

// ============================= HABIT MODAL =============================
document.getElementById('f-cat').addEventListener('change',toggleShieldLabels);
function toggleShieldLabels(){
  const isShield=document.getElementById('f-cat').value==='shield';
  document.getElementById('f-green-group').style.display=isShield?'none':'block';
  document.getElementById('f-yellow-group').style.display=isShield?'none':'block';
  document.getElementById('f-shield-labels').style.display=isShield?'block':'none';
}
function openAdd(){
  editId=null;document.getElementById('mh-title').textContent='New Habit';
  document.getElementById('f-name').value='';document.getElementById('f-green').value='';document.getElementById('f-yellow').value='';
  document.getElementById('f-green-s').value='';document.getElementById('f-yellow-s').value='';
  document.getElementById('f-cat').value='growth';document.getElementById('f-freq').value='7';document.getElementById('f-free').value='0';
  document.getElementById('btn-save').textContent='Create Habit';document.getElementById('btn-del').style.display='none';
  toggleShieldLabels();openMo('mo-habit');
}
function openEdit(id){
  const h=D.habits.find(x=>x.id===id);if(!h)return;editId=id;
  document.getElementById('mh-title').textContent='Edit Habit';
  document.getElementById('f-name').value=h.name;document.getElementById('f-cat').value=h.cat||'growth';
  document.getElementById('f-freq').value=h.freq;document.getElementById('f-free').value=h.freeDays||'0';
  toggleShieldLabels();
  if(h.cat==='shield'){document.getElementById('f-green-s').value=h.greenDesc;document.getElementById('f-yellow-s').value=h.yellowDesc}
  else{document.getElementById('f-green').value=h.greenDesc;document.getElementById('f-yellow').value=h.yellowDesc}
  document.getElementById('btn-save').textContent='Save Changes';document.getElementById('btn-del').style.display='block';
  openMo('mo-habit');
}
function saveHabit(){
  const name=document.getElementById('f-name').value.trim();
  const cat=document.getElementById('f-cat').value;
  const isShield=cat==='shield';
  const gd=isShield?document.getElementById('f-green-s').value.trim():document.getElementById('f-green').value.trim();
  const yd=isShield?document.getElementById('f-yellow-s').value.trim():document.getElementById('f-yellow').value.trim();
  const freq=document.getElementById('f-freq').value;const free=document.getElementById('f-free').value;
  if(!name||!gd||!yd){toast('Fill in all fields','tr');return}
  if(editId){const h=D.habits.find(x=>x.id===editId);if(h){h.name=name;h.cat=cat;h.greenDesc=gd;h.yellowDesc=yd;h.freq=freq;h.freeDays=free}}
  else{D.habits.push({id:'h_'+Date.now(),name,cat,greenDesc:gd,yellowDesc:yd,freq,freeDays:free,createdAt:new Date().toISOString()});toast('‚úì Habit created!','tg')}
  save();closeMo('mo-habit');renderToday();
}
function delHabit(){
  if(!editId||!confirm('Delete this habit and all data?'))return;
  D.habits=D.habits.filter(h=>h.id!==editId);
  Object.keys(D.entries).forEach(k=>{delete D.entries[k][editId];delete D.entries[k]['_note_'+editId]});
  save();closeMo('mo-habit');renderToday();toast('Habit deleted','tr');
}

// ============================= MODAL UTILS =============================
function openMo(id){document.getElementById(id).classList.add('show')}
function closeMo(id){document.getElementById(id).classList.remove('show')}
document.querySelectorAll('.mo').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)closeMo(m.id)})});

// ============================= EXPORT / IMPORT =============================
function exportData(){const b=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='ngtz-'+todayDk()+'.json';a.click();toast('‚úì Exported!','tg')}
function importData(){const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const imp=JSON.parse(r.result);if(imp.habits&&imp.entries){if(confirm('Replace all data?')){D=imp;if(!D.mood)D.mood={};if(!D.moments)D.moments={};if(!D.vision)D.vision={};save();renderToday();toast('‚úì Imported!','tg')}}else toast('Invalid file','tr')}catch(e){toast('Error reading file','tr')}};r.readAsText(f)};i.click()}
function toast(msg,cls){const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+(cls||'')+' show';setTimeout(()=>t.classList.remove('show'),2500)}

// ============================= SERVICE WORKER =============================
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{})}

// ============================= INIT =============================
if(!D.mood)D.mood={};if(!D.moments)D.moments={};if(!D.vision)D.vision={};save();
renderToday();checkMilestones();
</script>
</body>
</html>
